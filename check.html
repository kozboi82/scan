<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìì‚° ì ê²€</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        /* ===== SJU Design System Variables ===== */
        :root {
            --sju-primary: #11306E;
            --sju-primary-hover: #0a1f4a;
            --sju-accent: #E6007E;
            --sju-success: #00978E;
            --sju-success-bg: #e0f2f1;
            --sju-warning: #f59e0b;
            --sju-warning-bg: #fef3c7;
            --sju-danger: #ef4444;
            --sju-danger-bg: #fee2e2;
            --sju-info: #0284c7;
            --sju-info-bg: #e0f2fe;
            --sju-purple: #7c3aed;
            --sju-purple-bg: #ede9fe;
            --sju-gray-100: #f5f5f5;
            --sju-gray-200: #eeeeee;
            --sju-gray-300: #e0e0e0;
            --sju-gray-500: #9e9e9e;
            --sju-gray-600: #757575;
            --sju-gray-700: #616161;
            --sju-gray-800: #424242;
            --sju-white: #ffffff;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* í˜ì´ì§€ í™•ëŒ€ ë°©ì§€ */
        html {
            height: 100%;
            overflow: hidden;
            touch-action: manipulation;
        }

        body {
            font-family: 'Pretendard', 'Malgun Gothic', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--sju-gray-100);
            height: 100%;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        /* ì „ì²´ ë ˆì´ì•„ì›ƒ ì»¨í…Œì´ë„ˆ */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .fixed-top {
            flex-shrink: 0;
        }

        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* ===== Header ===== */
        .header {
            background-color: var(--sju-primary);
            color: var(--sju-white);
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            z-index: 100;
        }
        .header-title { font-size: 18px; font-weight: 600; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .header-count { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 16px; font-size: 12px; }
        .header-settings {
            width: 32px; height: 32px; border-radius: 50%;
            background: rgba(255,255,255,0.2); border: none;
            color: var(--sju-white); font-size: 18px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* ===== Scan Area ===== */
        .scan-container {
            margin: 8px 12px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            background: #000;
            flex-shrink: 0;
            touch-action: none; /* í•€ì¹˜ì¤Œ ë°©ì§€ */
        }

        .scan-mode-tabs {
            display: flex;
            background: var(--sju-primary);
        }
        .scan-mode-tab {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.6);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .scan-mode-tab.active {
            background: rgba(255,255,255,0.15);
            color: var(--sju-white);
        }
        .scan-mode-tab:active { opacity: 0.8; }

        #reader {
            width: 100%;
            min-height: 300px;
            background: #000;
            overflow: hidden;
            touch-action: none; /* í•€ì¹˜ì¤Œ ë°©ì§€ */
        }
        #reader video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            touch-action: none; /* í•€ì¹˜ì¤Œ ë°©ì§€ */
        }

        .scan-status {
            padding: 10px 16px;
            background: rgba(0,0,0,0.8);
            color: var(--sju-white);
            font-size: 12px;
            text-align: center;
        }
        .scan-status.success { background: var(--sju-success); }
        .scan-status.error { background: var(--sju-danger); }

        /* ì¤Œ ìŠ¬ë¼ì´ë” */
        .zoom-container {
            display: none;
            padding: 8px 16px;
            background: rgba(0,0,0,0.6);
            align-items: center;
            gap: 10px;
        }
        .zoom-container.active { display: flex; }
        .zoom-label {
            color: var(--sju-white);
            font-size: 11px;
            white-space: nowrap;
        }
        .zoom-slider {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            outline: none;
        }
        .zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--sju-white);
            border-radius: 50%;
            cursor: pointer;
        }
        .zoom-value {
            color: var(--sju-white);
            font-size: 11px;
            min-width: 32px;
            text-align: right;
        }

        .scan-controls {
            display: flex;
            gap: 8px;
            padding: 10px;
            background: linear-gradient(135deg, var(--sju-primary) 0%, #1a4a9e 100%);
        }
        .scan-control-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: var(--radius-sm);
            background: rgba(255,255,255,0.1);
            color: var(--sju-white);
            font-size: 12px;
            cursor: pointer;
        }
        .scan-control-btn:active { background: rgba(255,255,255,0.2); }
        .scan-control-btn.primary {
            background: var(--sju-accent);
            border-color: var(--sju-accent);
            font-weight: 600;
        }

        /* ===== OCR Scan Area (for OCR mode) ===== */
        .ocr-scan-area {
            padding: 40px 16px;
            text-align: center;
            background: linear-gradient(135deg, var(--sju-primary) 0%, #1a4a9e 100%);
            cursor: pointer;
            display: none;
        }
        .ocr-scan-area.active { display: block; }
        .ocr-scan-area:active { opacity: 0.9; }
        .ocr-scan-icon { font-size: 40px; margin-bottom: 8px; }
        .ocr-scan-text { color: var(--sju-white); font-size: 14px; font-weight: 500; }
        .ocr-scan-hint { color: rgba(255,255,255,0.7); font-size: 11px; margin-top: 6px; }

        /* ===== Results Section ===== */
        .results-section {
            padding: 0 12px;
            padding-bottom: 12px;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y; /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš© */
        }
        .results-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 4px; gap: 8px;
        }
        .results-title { font-size: 14px; font-weight: 600; color: var(--sju-gray-700); }
        .results-actions { display: flex; gap: 8px; align-items: center; }
        .results-count { font-size: 12px; color: var(--sju-gray-500); }
        .btn-batch {
            padding: 6px 12px; font-size: 12px; font-weight: 500;
            background: var(--sju-primary); color: var(--sju-white);
            border: none; border-radius: var(--radius-sm); cursor: pointer;
        }
        .btn-batch:disabled { background: var(--sju-gray-300); color: var(--sju-gray-500); }
        .btn-select-all {
            padding: 6px 10px; font-size: 11px;
            background: var(--sju-gray-200); color: var(--sju-gray-700);
            border: none; border-radius: var(--radius-sm); cursor: pointer;
        }

        /* ===== Result Item ===== */
        .result-item {
            background: var(--sju-white);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }
        .result-item.expanded { border: 2px solid var(--sju-primary); }
        .result-item-header {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 14px; cursor: pointer;
        }
        .result-item-header:active { background: var(--sju-gray-100); }
        .result-checkbox {
            width: 20px; height: 20px; cursor: pointer;
            accent-color: var(--sju-primary);
        }
        .result-status {
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; flex-shrink: 0;
        }
        .result-status.ok { background: var(--sju-success-bg); color: var(--sju-success); }
        .result-status.move { background: var(--sju-info-bg); color: var(--sju-info); }
        .result-status.warning { background: var(--sju-warning-bg); color: var(--sju-warning); }
        .result-status.danger { background: var(--sju-danger-bg); color: var(--sju-danger); }
        .result-status.new { background: var(--sju-purple-bg); color: var(--sju-purple); }
        .result-status.pending { background: var(--sju-gray-200); color: var(--sju-gray-600); }
        .result-info { flex: 1; min-width: 0; }
        .result-serial {
            font-family: 'Consolas', monospace;
            font-size: 13px; font-weight: 600; color: var(--sju-gray-800);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .result-detail { font-size: 11px; color: var(--sju-gray-600); margin-top: 2px; }
        .result-badge {
            font-size: 10px; padding: 3px 8px; border-radius: 10px;
            font-weight: 500; white-space: nowrap;
        }
        .badge-ok { background: var(--sju-success-bg); color: var(--sju-success); }
        .badge-move { background: var(--sju-info-bg); color: var(--sju-info); }
        .badge-repair { background: var(--sju-warning-bg); color: #d97706; }
        .badge-dispose { background: var(--sju-danger-bg); color: var(--sju-danger); }
        .badge-lost { background: #ffedd5; color: #ea580c; }
        .badge-delivery { background: #dbeafe; color: #2563eb; }
        .badge-unregistered { background: var(--sju-gray-200); color: var(--sju-gray-700); }
        .badge-new { background: var(--sju-purple-bg); color: var(--sju-purple); }
        .result-delete {
            width: 28px; height: 28px; border: none; background: none;
            color: var(--sju-gray-500); font-size: 16px; cursor: pointer;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
        }
        .result-delete:hover { background: var(--sju-danger-bg); color: var(--sju-danger); }

        /* ===== Result Item Expanded ===== */
        .result-expanded {
            padding: 0 14px 14px;
            border-top: 1px solid var(--sju-gray-200);
            display: none;
        }
        .result-item.expanded .result-expanded { display: block; }
        .expand-section { margin-top: 12px; }
        .expand-label { font-size: 11px; color: var(--sju-gray-600); margin-bottom: 6px; font-weight: 500; }
        .expand-value { font-size: 13px; color: var(--sju-gray-800); }
        .expand-row { display: flex; gap: 12px; margin-bottom: 10px; }
        .expand-col { flex: 1; }
        .expand-select {
            width: 100%; padding: 8px 10px; border: 1px solid var(--sju-gray-300);
            border-radius: var(--radius-sm); font-size: 13px;
        }
        .expand-actions { display: flex; gap: 8px; margin-top: 12px; }
        .expand-btn {
            flex: 1; padding: 10px; border: none; border-radius: var(--radius-sm);
            font-size: 13px; font-weight: 500; cursor: pointer;
        }
        .expand-btn.primary { background: var(--sju-primary); color: var(--sju-white); }
        .expand-btn.secondary { background: var(--sju-gray-200); color: var(--sju-gray-700); }

        /* ===== Empty State ===== */
        .empty-state { text-align: center; padding: 40px 20px; color: var(--sju-gray-500); }
        .empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
        .empty-text { font-size: 14px; }

        /* ===== Bottom Section ===== */
        .bottom-section {
            flex-shrink: 0;
            background: var(--sju-white);
            border-top: 1px solid var(--sju-gray-200);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .location-bar {
            padding: 10px 16px;
            display: flex; align-items: center; gap: 10px;
            border-bottom: 1px solid var(--sju-gray-200);
            cursor: pointer;
        }
        .location-bar:active { background: var(--sju-gray-100); }
        .location-icon { font-size: 16px; }
        .location-text { flex: 1; }
        .location-label { font-size: 10px; color: var(--sju-gray-500); }
        .location-value { font-size: 13px; font-weight: 500; color: var(--sju-gray-800); }
        .location-arrow { color: var(--sju-gray-500); font-size: 12px; }

        .bottom-buttons { padding: 12px 16px; display: flex; gap: 10px; }
        .btn-complete {
            flex: 1; padding: 14px;
            background: var(--sju-primary); color: var(--sju-white);
            border: none; border-radius: var(--radius-md);
            font-size: 15px; font-weight: 600; cursor: pointer;
        }
        .btn-complete:active { background: var(--sju-primary-hover); }
        .btn-complete:disabled { background: #bdbdbd; cursor: not-allowed; }

        /* ===== Modals ===== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: flex-end;
            z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: var(--sju-white); width: 100%; max-height: 85vh;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            padding: 20px; padding-bottom: max(20px, env(safe-area-inset-bottom));
            animation: slideUp 0.3s ease-out; overflow-y: auto;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px;
        }
        .modal-title { font-size: 17px; font-weight: 600; color: var(--sju-gray-800); }
        .modal-close {
            width: 30px; height: 30px; border: none;
            background: var(--sju-gray-100); border-radius: 50%;
            font-size: 18px; color: var(--sju-gray-600); cursor: pointer;
        }

        /* ===== Multi Serial Modal ===== */
        .serial-select-item {
            display: flex; align-items: center; gap: 10px;
            padding: 12px; background: var(--sju-gray-100);
            border-radius: var(--radius-md); margin-bottom: 8px;
        }
        .serial-select-item.disabled { opacity: 0.5; }
        .serial-select-check { width: 20px; height: 20px; accent-color: var(--sju-primary); }
        .serial-select-info { flex: 1; }
        .serial-select-sn {
            font-family: 'Consolas', monospace; font-weight: 600;
            font-size: 14px; color: var(--sju-gray-800);
        }
        .serial-select-status { font-size: 11px; color: var(--sju-gray-600); margin-top: 2px; }
        .serial-select-edit {
            padding: 6px 10px; font-size: 11px;
            background: var(--sju-white); border: 1px solid var(--sju-gray-300);
            border-radius: var(--radius-sm); cursor: pointer;
        }
        .modal-actions { display: flex; gap: 8px; margin-top: 16px; }
        .modal-btn {
            flex: 1; padding: 12px; border: none; border-radius: var(--radius-md);
            font-size: 14px; font-weight: 500; cursor: pointer;
        }
        .modal-btn.primary { background: var(--sju-primary); color: var(--sju-white); }
        .modal-btn.secondary { background: var(--sju-gray-200); color: var(--sju-gray-700); }

        /* ===== Batch Modal ===== */
        .batch-section { margin-bottom: 16px; }
        .batch-label { font-size: 13px; font-weight: 600; color: var(--sju-gray-700); margin-bottom: 8px; }
        .batch-options { display: flex; flex-wrap: wrap; gap: 8px; }
        .batch-option {
            padding: 10px 16px; border: 1px solid var(--sju-gray-300);
            border-radius: var(--radius-md); font-size: 13px;
            background: var(--sju-white); cursor: pointer;
        }
        .batch-option.selected { border-color: var(--sju-primary); background: #e8eaf6; color: var(--sju-primary); }
        .batch-option:disabled { opacity: 0.5; cursor: not-allowed; }

        /* ===== Commit Modal ===== */
        .commit-summary { margin-bottom: 16px; }
        .commit-item {
            display: flex; align-items: center; gap: 8px;
            padding: 10px; background: var(--sju-gray-100);
            border-radius: var(--radius-sm); margin-bottom: 6px; font-size: 12px;
        }
        .commit-item-serial { font-family: 'Consolas', monospace; font-weight: 600; flex: 1; }
        .commit-item-action { color: var(--sju-gray-600); }

        /* ===== Settings Modal ===== */
        .settings-item { margin-bottom: 16px; }
        .settings-label { font-size: 12px; color: var(--sju-gray-600); margin-bottom: 6px; }
        .settings-input {
            width: 100%; padding: 12px;
            border: 1px solid var(--sju-gray-300); border-radius: var(--radius-sm);
            font-size: 14px;
        }
        .settings-input:focus { outline: none; border-color: var(--sju-primary); }

        /* ===== Department List ===== */
        .dept-list { max-height: 300px; overflow-y: auto; }
        .dept-item {
            padding: 12px 14px; border-bottom: 1px solid var(--sju-gray-200);
            cursor: pointer;
        }
        .dept-item:active { background: var(--sju-gray-100); }
        .dept-item.selected { background: #e8f5e9; }
        .dept-name { font-size: 14px; color: var(--sju-gray-800); }
        .dept-location { font-size: 11px; color: var(--sju-gray-500); }

        /* ===== Toast ===== */
        .toast {
            position: fixed; bottom: 120px; left: 50%;
            transform: translateX(-50%) translateY(50px);
            background: rgba(0,0,0,0.85); color: var(--sju-white);
            padding: 10px 20px; border-radius: 20px; font-size: 13px;
            opacity: 0; transition: all 0.3s ease; z-index: 2000; pointer-events: none;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* ===== Loading ===== */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            display: none; justify-content: center; align-items: center; flex-direction: column;
            z-index: 3000;
        }
        .loading-overlay.active { display: flex; }
        .loading-spinner {
            width: 36px; height: 36px;
            border: 3px solid var(--sju-gray-200); border-top-color: var(--sju-primary);
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 12px; font-size: 13px; color: var(--sju-gray-600); }

        .file-input-hidden { display: none; }
    </style>
</head>
<body>
    <div class="app-container">
    <!-- Header -->
    <div class="header">
        <span class="header-title">ìì‚° ì ê²€</span>
        <div class="header-right">
            <span class="header-count" id="headerCount">0ê±´</span>
            <button class="header-settings" onclick="openSettingsModal()">âš™</button>
        </div>
    </div>

    <!-- Scan Container -->
    <div class="scan-container">
        <!-- Scan Mode Tabs -->
        <div class="scan-mode-tabs">
            <button class="scan-mode-tab active" onclick="setScanMode('auto', this)">ìë™</button>
            <button class="scan-mode-tab" onclick="setScanMode('qr', this)">QR</button>
            <button class="scan-mode-tab" onclick="setScanMode('barcode', this)">ë°”ì½”ë“œ</button>
            <button class="scan-mode-tab" onclick="setScanMode('ocr', this)">OCR</button>
        </div>

        <!-- QR/Barcode Scanner -->
        <div id="reader"></div>

        <!-- OCR Scan Area (hidden by default) -->
        <div class="ocr-scan-area" id="ocrScanArea" onclick="triggerOcrScan()">
            <div class="ocr-scan-icon">ğŸ“·</div>
            <div class="ocr-scan-text">íƒ­í•˜ì—¬ ë¼ë²¨ ì´¬ì˜</div>
            <div class="ocr-scan-hint">í…ìŠ¤íŠ¸ ì¸ì‹ (Google Vision API)</div>
        </div>

        <!-- Scan Status -->
        <div class="scan-status" id="scanStatus">QR/ë°”ì½”ë“œë¥¼ ë¹„ì¶°ì£¼ì„¸ìš” (ì¸ì‹ ì•ˆë˜ë©´ ğŸ“¸OCR ë²„íŠ¼)</div>

        <!-- Zoom Slider -->
        <div class="zoom-container" id="zoomContainer">
            <span class="zoom-label">ğŸ”</span>
            <input type="range" class="zoom-slider" id="zoomSlider" min="1" max="5" step="0.1" value="1">
            <span class="zoom-value" id="zoomValue">1.0x</span>
        </div>

        <!-- Scan Controls -->
        <div class="scan-controls">
            <button class="scan-control-btn primary" onclick="captureAndOcr()" id="btnCaptureOcr">ğŸ“¸ OCR</button>
            <button class="scan-control-btn" onclick="manualInput()">âœï¸ ì§ì ‘ì…ë ¥</button>
            <button class="scan-control-btn" onclick="restartScanner()">ğŸ”„ ì¬ìŠ¤ìº”</button>
        </div>
    </div>
    <input type="file" id="fileInput" class="file-input-hidden" accept="image/*" capture="environment">

    <!-- Results Section -->
    <div class="results-section">
        <div class="results-header">
            <span class="results-title">ìŠ¤ìº” ëª©ë¡</span>
            <div class="results-actions">
                <span class="results-count" id="resultsCount">0ê±´</span>
                <button class="btn-select-all" id="btnSelectAll" onclick="toggleSelectAll()">ì „ì²´ì„ íƒ</button>
                <button class="btn-batch" id="btnBatch" onclick="openBatchModal()" disabled>ì¼ê´„ì‘ì—…</button>
            </div>
        </div>
        <div id="resultsList">
            <div class="empty-state">
                <div class="empty-icon">ğŸ“‹</div>
                <div class="empty-text">ìŠ¤ìº”ëœ ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤<br><small>ìƒë‹¨ ì¹´ë©”ë¼ë¡œ ìŠ¤ìº”ì„ ì‹œì‘í•˜ì„¸ìš”</small></div>
            </div>
        </div>
    </div>

    <!-- Bottom Section -->
    <div class="bottom-section">
        <div class="location-bar" onclick="openDeptModal()">
            <span class="location-icon">ğŸ“</span>
            <div class="location-text">
                <div class="location-label">í˜„ì¬ ìœ„ì¹˜</div>
                <div class="location-value" id="currentDept">íƒ­í•˜ì—¬ ì„ íƒ</div>
            </div>
            <span class="location-arrow">â–¶</span>
        </div>
        <div class="bottom-buttons">
            <button class="btn-complete" id="btnComplete" onclick="openCommitModal()" disabled>
                ì ê²€ ì™„ë£Œ
            </button>
        </div>
    </div>
    </div><!-- end app-container -->

    <!-- Multi Serial Select Modal -->
    <div class="modal-overlay" id="multiSerialModal">
        <div class="modal-content" id="multiSerialContent"></div>
    </div>

    <!-- Batch Action Modal -->
    <div class="modal-overlay" id="batchModal">
        <div class="modal-content" id="batchModalContent"></div>
    </div>

    <!-- Commit Confirm Modal -->
    <div class="modal-overlay" id="commitModal">
        <div class="modal-content" id="commitModalContent"></div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">ì„¤ì •</span>
                <button class="modal-close" onclick="closeSettingsModal()">Ã—</button>
            </div>
            <div class="settings-item">
                <div class="settings-label">Google Vision API Key (OCR ëª¨ë“œìš©)</div>
                <input type="password" class="settings-input" id="apiKey" placeholder="API Key ì…ë ¥...">
            </div>
            <button class="modal-btn primary" onclick="saveSettings()">ì €ì¥</button>
        </div>
    </div>

    <!-- Department Modal -->
    <div class="modal-overlay" id="deptModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">ì ê²€ ìœ„ì¹˜ ì„ íƒ</span>
                <button class="modal-close" onclick="closeDeptModal()">Ã—</button>
            </div>
            <div class="dept-list" id="deptList"></div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Loading -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">ì¸ì‹ ì¤‘...</div>
    </div>

    <!-- Scripts -->
    <script src="js/mock-data.js"></script>
    <script>
        // ===== State (v2: Staging-Commit êµ¬ì¡°) =====
        var currentDeptCode = null;
        var currentDeptName = null;
        var scannedItems = [];  // { serial, caseType, original, changes, checked, needsInput }
        var pendingSerials = []; // ì„ ë³„ ëª¨ë‹¬ìš© ì„ì‹œ ì €ì¥

        // ===== Scanner State =====
        var html5QrCode = null;
        var currentScanMode = 'auto';
        var isScanning = false;
        var lastScannedCode = '';
        var scanCooldown = false;

        // ===== Initialization =====
        document.addEventListener('DOMContentLoaded', function() {
            var savedKey = localStorage.getItem('google_vision_api_key');
            if (savedKey) document.getElementById('apiKey').value = savedKey;
            document.getElementById('fileInput').addEventListener('change', handleOcrFileSelect);
            initDeptList();
            startScanner();
        });

        // ===== Scanner =====
        function startScanner() {
            if (currentScanMode === 'ocr') {
                stopScanner();
                return;
            }

            var statusEl = document.getElementById('scanStatus');
            statusEl.className = 'scan-status';
            statusEl.textContent = 'ì¹´ë©”ë¼ ì‹œì‘ ì¤‘...';

            html5QrCode = new Html5Qrcode("reader");

            // ocr-test-qrcode.htmlê³¼ ë™ì¼í•œ ì„¤ì •
            var config = {
                fps: 10,
                qrbox: { width: 280, height: 280 }
            };

            var formats = getFormatsForMode(currentScanMode);
            if (currentScanMode === 'barcode') {
                config.qrbox = { width: 350, height: 150 };
            }

            // formatsToSupportë¥¼ configì— ì§ì ‘ ì¶”ê°€ (ocr-test-qrcode.html ë°©ì‹)
            config.formatsToSupport = formats;

            // ë‹¨ìˆœí•œ ì¹´ë©”ë¼ ì„¤ì • (ocr-test-qrcode.html ë°©ì‹)
            html5QrCode.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanFailure
            ).then(function() {
                isScanning = true;
                statusEl.textContent = 'QR/ë°”ì½”ë“œ ë¹„ì¶”ê¸° ë˜ëŠ” ğŸ“¸OCR';
                // ì¹´ë©”ë¼ ì¤Œ ê¸°ëŠ¥ ì´ˆê¸°í™” (í•˜ë“œì›¨ì–´ ì¤Œ ì‹¤íŒ¨ ì‹œ ì†Œí”„íŠ¸ì›¨ì–´ ì¤Œ)
                setupCameraZoom();
            }).catch(function(err) {
                console.error('Scanner error:', err);
                statusEl.className = 'scan-status error';
                statusEl.textContent = 'ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: ' + err;
            });
        }

        // ===== Camera Zoom (Hardware + Software Fallback) =====
        var cameraTrack = null;
        var zoomCapabilities = null;
        var isSoftwareZoom = false;

        function setupCameraZoom() {
            // ë¹„ë””ì˜¤ ë¡œë”© ëŒ€ê¸°
            setTimeout(function() {
                try {
                    var video = document.querySelector('#reader video');
                    if (!video) {
                        console.log('Video element not found');
                        return;
                    }

                    var slider = document.getElementById('zoomSlider');
                    var container = document.getElementById('zoomContainer');
                    var valueEl = document.getElementById('zoomValue');

                    // 1. í•˜ë“œì›¨ì–´ ì¤Œ ì‹œë„ (ì•ˆë“œë¡œì´ë“œ ë“±)
                    if (video.srcObject) {
                        var stream = video.srcObject;
                        var tracks = stream.getVideoTracks();
                        if (tracks.length > 0) {
                            cameraTrack = tracks[0];
                            var capabilities = cameraTrack.getCapabilities ? cameraTrack.getCapabilities() : {};

                            if (capabilities && capabilities.zoom) {
                                // í•˜ë“œì›¨ì–´ ì¤Œ ì§€ì›
                                isSoftwareZoom = false;
                                zoomCapabilities = capabilities.zoom;
                                slider.min = zoomCapabilities.min;
                                slider.max = zoomCapabilities.max;
                                slider.step = zoomCapabilities.step || 0.1;
                                slider.value = cameraTrack.getSettings().zoom || 1;
                                console.log('Using Hardware Zoom:', zoomCapabilities);
                            } else {
                                // í•˜ë“œì›¨ì–´ ì¤Œ ë¯¸ì§€ì› (ì•„ì´í° ë“±) -> ì†Œí”„íŠ¸ì›¨ì–´ ì¤Œ
                                isSoftwareZoom = true;
                                slider.min = 1;
                                slider.max = 3;
                                slider.step = 0.1;
                                slider.value = 1;
                                console.log('Using Software Zoom (CSS)');
                            }
                        } else {
                            // íŠ¸ë™ ì—†ìŒ -> ì†Œí”„íŠ¸ì›¨ì–´ ì¤Œ
                            isSoftwareZoom = true;
                            slider.min = 1;
                            slider.max = 3;
                            slider.step = 0.1;
                            slider.value = 1;
                        }
                    } else {
                        // srcObject ì—†ìŒ -> ì†Œí”„íŠ¸ì›¨ì–´ ì¤Œ
                        isSoftwareZoom = true;
                        slider.min = 1;
                        slider.max = 3;
                        slider.step = 0.1;
                        slider.value = 1;
                    }

                    // ìŠ¬ë¼ì´ë” UI í‘œì‹œ
                    container.classList.add('active');
                    valueEl.textContent = parseFloat(slider.value).toFixed(1) + 'x';

                    // ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
                    slider.oninput = function(e) {
                        var zoomValue = parseFloat(e.target.value);
                        valueEl.textContent = zoomValue.toFixed(1) + 'x';
                        applyCameraZoom(zoomValue);
                    };

                } catch (err) {
                    console.error('Zoom setup error:', err);
                    // ì—ëŸ¬ ì‹œì—ë„ ì†Œí”„íŠ¸ì›¨ì–´ ì¤Œ í™œì„±í™”
                    isSoftwareZoom = true;
                    var container = document.getElementById('zoomContainer');
                    var slider = document.getElementById('zoomSlider');
                    slider.min = 1;
                    slider.max = 3;
                    slider.value = 1;
                    container.classList.add('active');
                }
            }, 500);
        }

        function applyCameraZoom(zoomValue) {
            try {
                if (isSoftwareZoom) {
                    // ì†Œí”„íŠ¸ì›¨ì–´ ì¤Œ: CSSë¡œ ë¹„ë””ì˜¤ í™•ëŒ€
                    var video = document.querySelector('#reader video');
                    if (video) {
                        video.style.transform = 'scale(' + zoomValue + ')';
                        video.style.transformOrigin = 'center center';
                    }
                } else {
                    // í•˜ë“œì›¨ì–´ ì¤Œ: ì‹¤ì œ ì¹´ë©”ë¼ ë Œì¦ˆ ì¤Œ
                    if (cameraTrack && zoomCapabilities) {
                        cameraTrack.applyConstraints({
                            advanced: [{ zoom: zoomValue }]
                        });
                    }
                }
            } catch (err) {
                console.error('Zoom apply error:', err);
            }
        }

        function hideZoomSlider() {
            document.getElementById('zoomContainer').classList.remove('active');
            // ì†Œí”„íŠ¸ì›¨ì–´ ì¤Œ ë¦¬ì…‹
            var video = document.querySelector('#reader video');
            if (video) {
                video.style.transform = '';
            }
            cameraTrack = null;
            zoomCapabilities = null;
            isSoftwareZoom = false;
        }

        function stopScanner() {
            hideZoomSlider();
            if (html5QrCode && isScanning) {
                html5QrCode.stop().then(function() {
                    isScanning = false;
                    document.getElementById('reader').innerHTML = '';
                }).catch(function(err) {
                    console.error('Stop error:', err);
                });
            }
        }

        function restartScanner() {
            stopScanner();
            setTimeout(function() {
                if (currentScanMode !== 'ocr') {
                    startScanner();
                }
            }, 300);
        }

        function getFormatsForMode(mode) {
            if (mode === 'qr') {
                return [Html5QrcodeSupportedFormats.QR_CODE];
            } else if (mode === 'barcode') {
                return [
                    Html5QrcodeSupportedFormats.CODE_128,
                    Html5QrcodeSupportedFormats.CODE_39,
                    Html5QrcodeSupportedFormats.EAN_13,
                    Html5QrcodeSupportedFormats.EAN_8,
                    Html5QrcodeSupportedFormats.UPC_A,
                    Html5QrcodeSupportedFormats.UPC_E,
                    Html5QrcodeSupportedFormats.ITF
                ];
            } else {
                // ocr-test-qrcode.htmlê³¼ ë™ì¼í•˜ê²Œ ITF, DATA_MATRIX í¬í•¨
                return [
                    Html5QrcodeSupportedFormats.QR_CODE,
                    Html5QrcodeSupportedFormats.CODE_128,
                    Html5QrcodeSupportedFormats.CODE_39,
                    Html5QrcodeSupportedFormats.EAN_13,
                    Html5QrcodeSupportedFormats.EAN_8,
                    Html5QrcodeSupportedFormats.UPC_A,
                    Html5QrcodeSupportedFormats.UPC_E,
                    Html5QrcodeSupportedFormats.ITF,
                    Html5QrcodeSupportedFormats.DATA_MATRIX
                ];
            }
        }

        function setScanMode(mode, btn) {
            currentScanMode = mode;

            // Update tabs
            document.querySelectorAll('.scan-mode-tab').forEach(function(t) {
                t.classList.remove('active');
            });
            btn.classList.add('active');

            // Toggle OCR/Scanner
            var readerEl = document.getElementById('reader');
            var ocrEl = document.getElementById('ocrScanArea');

            if (mode === 'ocr') {
                stopScanner();
                readerEl.style.display = 'none';
                ocrEl.classList.add('active');
                document.getElementById('scanStatus').textContent = 'OCR ëª¨ë“œ: ë¼ë²¨ì„ ì´¬ì˜í•˜ì„¸ìš”';
            } else {
                readerEl.style.display = 'block';
                ocrEl.classList.remove('active');
                restartScanner();
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            if (scanCooldown || decodedText === lastScannedCode) return;

            lastScannedCode = decodedText;
            scanCooldown = true;

            // Vibrate
            if (navigator.vibrate) navigator.vibrate(100);

            var statusEl = document.getElementById('scanStatus');
            statusEl.className = 'scan-status success';
            statusEl.textContent = 'ì¸ì‹ë¨: ' + decodedText;

            // Section 11 í”„ë¡œì„¸ìŠ¤: ì„ ë³„ ëª¨ë‹¬ë¡œ ì „ë‹¬
            processScannedCode(decodedText);

            // Reset cooldown after 2s (ëª¨ë‹¬ ë‹«íŒ í›„ ë‹¤ì‹œ ìŠ¤ìº” ê°€ëŠ¥)
            setTimeout(function() {
                scanCooldown = false;
                lastScannedCode = '';
                statusEl.className = 'scan-status';
                statusEl.textContent = 'QR/ë°”ì½”ë“œ ë¹„ì¶”ê¸° ë˜ëŠ” ğŸ“¸OCR';
            }, 2000);
        }

        function onScanFailure(errorMessage) {
            // Silent fail - continuous scanning
        }

        async function processScannedCode(code) {
            // Section 11 í”„ë¡œì„¸ìŠ¤: ìŠ¤ìº” â†’ ì„ ë³„ ëª¨ë‹¬ â†’ ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
            showLoading(true, 'ì¡°íšŒ ì¤‘...');
            try {
                await showMultiSerialModal([code]);
            } catch (err) {
                showToast('ì¡°íšŒ ì‹¤íŒ¨: ' + err.message);
            }
            showLoading(false);
        }

        async function captureAndOcr() {
            // API Key í™•ì¸
            var apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                showToast('ì„¤ì •ì—ì„œ API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                openSettingsModal();
                return;
            }

            // ì¹´ë©”ë¼ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
            if (!html5QrCode || !isScanning) {
                showToast('ì¹´ë©”ë¼ê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤');
                return;
            }

            try {
                // í˜„ì¬ ì¹´ë©”ë¼ í”„ë ˆì„ ìº¡ì²˜
                var video = document.querySelector('#reader video');
                if (!video) {
                    showToast('ì¹´ë©”ë¼ í™”ë©´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }

                var canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);

                var dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                var base64 = dataUrl.split(',')[1];

                // ìƒíƒœ í‘œì‹œ
                var statusEl = document.getElementById('scanStatus');
                statusEl.textContent = 'OCR ì¸ì‹ ì¤‘...';

                showLoading(true, 'OCR ì¸ì‹ ì¤‘...');

                // Google Vision API í˜¸ì¶œ
                var text = await callVisionAPI(base64, apiKey);

                if (!text) {
                    showToast('í…ìŠ¤íŠ¸ë¥¼ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
                    showLoading(false);
                    statusEl.textContent = 'QR/ë°”ì½”ë“œ ë¹„ì¶”ê¸° ë˜ëŠ” ğŸ“¸OCR';
                    return;
                }

                var serials = extractSerials(text);
                if (serials.length === 0) {
                    showToast('ì‹œë¦¬ì–¼ ë²ˆí˜¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
                    showLoading(false);
                    statusEl.textContent = 'QR/ë°”ì½”ë“œ ë¹„ì¶”ê¸° ë˜ëŠ” ğŸ“¸OCR';
                    return;
                }

                showLoading(false);

                // ì¸ì‹ëœ ì‹œë¦¬ì–¼ ì²˜ë¦¬ (ë‹¨ì¼/ë‹¤ì¤‘ ëª¨ë‘ ì„ ë³„ ëª¨ë‹¬ ê±°ì¹¨)
                await showMultiSerialModal(serials);
                statusEl.className = 'scan-status success';
                statusEl.textContent = 'OCR ì¸ì‹: ' + serials.length + 'ê°œ';

                // ì§„ë™ í”¼ë“œë°±
                if (navigator.vibrate) navigator.vibrate(100);

            } catch (err) {
                console.error('OCR error:', err);
                showToast('OCR ì˜¤ë¥˜: ' + err.message);
                showLoading(false);
            }
        }

        function manualInput() {
            var serial = prompt('ì‹œë¦¬ì–¼ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            if (serial && serial.trim()) {
                processScannedCode(serial.trim().toUpperCase());
            }
        }

        // ===== OCR Scan (fallback for text labels) =====
        function triggerOcrScan() {
            var apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                showToast('ì„¤ì •ì—ì„œ API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                openSettingsModal();
                return;
            }
            document.getElementById('fileInput').click();
        }

        async function handleOcrFileSelect(e) {
            var file = e.target.files[0];
            if (!file) return;

            showLoading(true, 'OCR ì¸ì‹ ì¤‘...');
            try {
                var resized = await resizeImage(file, 1280);
                var apiKey = document.getElementById('apiKey').value;
                var text = await callVisionAPI(resized.base64, apiKey);

                if (!text) { showToast('í…ìŠ¤íŠ¸ë¥¼ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤'); showLoading(false); return; }

                var serials = extractSerials(text);
                if (serials.length === 0) { showToast('ì‹œë¦¬ì–¼ ë²ˆí˜¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤'); showLoading(false); return; }

                showLoading(false);

                // ì¡°íšŒ í›„ ì„ ë³„ ëª¨ë‹¬ í‘œì‹œ
                await showMultiSerialModal(serials);

            } catch (err) {
                console.error(err);
                showToast('ì˜¤ë¥˜: ' + err.message);
                showLoading(false);
            }
            e.target.value = '';
        }

        // ===== Settings =====
        function openSettingsModal() { document.getElementById('settingsModal').classList.add('active'); }
        function closeSettingsModal() { document.getElementById('settingsModal').classList.remove('active'); }
        function saveSettings() {
            localStorage.setItem('google_vision_api_key', document.getElementById('apiKey').value);
            closeSettingsModal();
            showToast('ì„¤ì • ì €ì¥ë¨');
        }

        // ===== Department =====
        async function initDeptList() {
            var depts = await getDepartments();
            var listEl = document.getElementById('deptList');
            listEl.innerHTML = depts.map(function(d) {
                return '<div class="dept-item" onclick="selectDept(\'' + d.code + '\',\'' + d.name + '\')">' +
                    '<div class="dept-name">' + d.name + '</div>' +
                    '<div class="dept-location">' + d.building + ' ' + d.floor + '</div></div>';
            }).join('');
        }

        function openDeptModal() { document.getElementById('deptModal').classList.add('active'); }
        function closeDeptModal() { document.getElementById('deptModal').classList.remove('active'); }

        function selectDept(code, name) {
            currentDeptCode = code;
            currentDeptName = name;
            document.getElementById('currentDept').textContent = MOCK_DEPARTMENTS[code].building + ' > ' + name;
            closeDeptModal();
            showToast('ìœ„ì¹˜: ' + name);
        }

        // ===== Multi Serial Select Modal =====
        async function showMultiSerialModal(serials) {
            pendingSerials = [];

            for (var i = 0; i < serials.length; i++) {
                var sn = serials[i];
                var isDuplicate = scannedItems.some(function(item) { return item.serial === sn; });
                var result = await lookupSerial(sn, currentDeptCode);
                pendingSerials.push({
                    serial: sn,
                    result: result,
                    checked: !isDuplicate,
                    isDuplicate: isDuplicate
                });
            }

            renderMultiSerialModal();
            document.getElementById('multiSerialModal').classList.add('active');
        }

        function renderMultiSerialModal() {
            var content = document.getElementById('multiSerialContent');
            var html = '<div class="modal-header">' +
                '<span class="modal-title">ì¸ì‹ëœ ì‹œë¦¬ì–¼ (' + pendingSerials.length + 'ê°œ)</span>' +
                '<button class="modal-close" onclick="closeMultiSerialModal()">Ã—</button></div>';

            html += '<div style="margin-bottom:12px; font-size:12px; color:var(--sju-gray-600);">ë¶ˆí•„ìš”í•œ í•­ëª©ì€ ì²´í¬ í•´ì œí•˜ì„¸ìš”</div>';

            pendingSerials.forEach(function(item, idx) {
                var statusText = getStatusText(item.result.case, item.result.data);
                var disabledClass = item.isDuplicate ? ' disabled' : '';
                var duplicateNote = item.isDuplicate ? ' (ì´ë¯¸ ì¶”ê°€ë¨)' : '';

                html += '<div class="serial-select-item' + disabledClass + '">' +
                    '<input type="checkbox" class="serial-select-check" id="chk' + idx + '" ' +
                        (item.checked ? 'checked' : '') + (item.isDuplicate ? ' disabled' : '') +
                        ' onchange="togglePendingSerial(' + idx + ')">' +
                    '<div class="serial-select-info">' +
                        '<div class="serial-select-sn">' + item.serial + '</div>' +
                        '<div class="serial-select-status">' + statusText + duplicateNote + '</div>' +
                    '</div>' +
                    '<button class="serial-select-edit" onclick="editPendingSerial(' + idx + ')">ìˆ˜ì •</button>' +
                '</div>';
            });

            html += '<div class="modal-actions">' +
                '<button class="modal-btn secondary" onclick="closeMultiSerialModal()">ì·¨ì†Œ</button>' +
                '<button class="modal-btn primary" onclick="addSelectedSerials()">ì„ íƒ ì¶”ê°€</button>' +
            '</div>';

            content.innerHTML = html;
        }

        function togglePendingSerial(idx) {
            pendingSerials[idx].checked = document.getElementById('chk' + idx).checked;
        }

        function editPendingSerial(idx) {
            var newSerial = prompt('ì‹œë¦¬ì–¼ ìˆ˜ì •:', pendingSerials[idx].serial);
            if (newSerial && newSerial.trim()) {
                newSerial = newSerial.trim().toUpperCase();
                pendingSerials[idx].serial = newSerial;
                pendingSerials[idx].isDuplicate = scannedItems.some(function(item) { return item.serial === newSerial; });
                lookupSerial(newSerial, currentDeptCode).then(function(result) {
                    pendingSerials[idx].result = result;
                    pendingSerials[idx].checked = !pendingSerials[idx].isDuplicate;
                    renderMultiSerialModal();
                });
            }
        }

        function addSelectedSerials() {
            var added = 0;
            pendingSerials.forEach(function(item) {
                if (item.checked && !item.isDuplicate) {
                    var newItem = createScannedItem(item.serial, item.result);
                    scannedItems.push(newItem);
                    added++;
                }
            });

            closeMultiSerialModal();
            updateUI();
            showToast(added + 'ê±´ ì¶”ê°€ë¨');
        }

        function closeMultiSerialModal() {
            document.getElementById('multiSerialModal').classList.remove('active');
            pendingSerials = [];
        }

        // ===== Create Scanned Item =====
        function createScannedItem(serial, result) {
            var item = {
                serial: serial,
                caseType: result.case,
                original: result.data ? Object.assign({}, result.data) : null,
                changes: {},
                checked: true,
                needsInput: (result.case === 'B1' || result.case === 'C1'),
                source: result.source
            };

            if (result.case && result.case.startsWith('A2') && currentDeptCode) {
                item.changes.deptCode = currentDeptCode;
                item.changes.dept = currentDeptName;
            }

            return item;
        }

        // ===== UI Update =====
        function updateUI() {
            var count = scannedItems.length;
            var checkedCount = scannedItems.filter(function(i) { return i.checked; }).length;

            document.getElementById('headerCount').textContent = count + 'ê±´';
            document.getElementById('resultsCount').textContent = count + 'ê±´';
            document.getElementById('btnBatch').disabled = checkedCount === 0;
            document.getElementById('btnComplete').disabled = count === 0;
            document.getElementById('btnSelectAll').textContent = checkedCount === count ? 'ì „ì²´í•´ì œ' : 'ì „ì²´ì„ íƒ';

            var listEl = document.getElementById('resultsList');
            if (count === 0) {
                listEl.innerHTML = '<div class="empty-state">' +
                    '<div class="empty-icon">ğŸ“‹</div>' +
                    '<div class="empty-text">ìŠ¤ìº”ëœ ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤<br><small>ìƒë‹¨ ì¹´ë©”ë¼ë¡œ ìŠ¤ìº”ì„ ì‹œì‘í•˜ì„¸ìš”</small></div></div>';
                return;
            }

            listEl.innerHTML = scannedItems.map(function(item, idx) {
                return renderResultItem(item, idx);
            }).join('');
        }

        function renderResultItem(item, idx) {
            var icon = getStatusIcon(item.caseType);
            var statusClass = getStatusClass(item.caseType);
            var badge = getBadge(item);
            var detail = getDetail(item);
            var shouldExpand = shouldAutoExpand(item.caseType);
            var expandedClass = shouldExpand ? ' expanded' : '';

            var html = '<div class="result-item' + expandedClass + '" id="item' + idx + '">' +
                '<div class="result-item-header">' +
                    '<input type="checkbox" class="result-checkbox" ' + (item.checked ? 'checked' : '') +
                        ' onchange="toggleItemCheck(' + idx + ')" onclick="event.stopPropagation()">' +
                    '<div class="result-status ' + statusClass + '">' + icon + '</div>' +
                    '<div class="result-info" onclick="toggleItemExpand(' + idx + ')">' +
                        '<div class="result-serial">' + item.serial + '</div>' +
                        '<div class="result-detail">' + detail + '</div>' +
                    '</div>' +
                    '<span class="result-badge ' + badge.class + '">' + badge.text + '</span>' +
                    '<button class="result-delete" onclick="deleteItem(' + idx + ')" title="ì‚­ì œ">ğŸ—‘ï¸</button>' +
                '</div>' +
                '<div class="result-expanded">' + renderExpandedContent(item, idx) + '</div>' +
            '</div>';

            return html;
        }

        function renderExpandedContent(item, idx) {
            var html = '';

            if (item.original) {
                html += '<div class="expand-row">' +
                    '<div class="expand-col"><div class="expand-label">ì›ë˜ ë¶€ì„œ</div><div class="expand-value">' + item.original.dept + '</div></div>' +
                    '<div class="expand-col"><div class="expand-label">ì›ë˜ ìƒíƒœ</div><div class="expand-value">' + item.original.status + '</div></div>' +
                '</div>';
            }

            html += '<div class="expand-section">' +
                '<div class="expand-label">ë³€ê²½í•  ë¶€ì„œ</div>' +
                '<select class="expand-select" id="deptSelect' + idx + '" onchange="updateItemChange(' + idx + ', \'dept\')">' +
                    '<option value="">ë³€ê²½ ì•ˆ í•¨</option>';
            Object.values(MOCK_DEPARTMENTS).forEach(function(d) {
                var selected = (item.changes.deptCode === d.code) ? ' selected' : '';
                html += '<option value="' + d.code + '"' + selected + '>' + d.name + '</option>';
            });
            html += '</select></div>';

            if (needsStatusChange(item.caseType)) {
                html += '<div class="expand-section">' +
                    '<div class="expand-label">ìƒíƒœ ë³€ê²½</div>' +
                    '<select class="expand-select" id="statusSelect' + idx + '" onchange="updateItemChange(' + idx + ', \'status\')">' +
                        getStatusOptions(item) +
                    '</select></div>';
            }

            if (item.needsInput) {
                html += '<div class="expand-section">' +
                    '<div class="expand-label">ì¥ë¹„ ìœ í˜• *</div>' +
                    '<select class="expand-select" id="typeSelect' + idx + '" onchange="updateItemChange(' + idx + ', \'assetType\')">' +
                        '<option value="">ì„ íƒ</option>' +
                        '<option value="PC"' + (item.changes.assetType === 'PC' ? ' selected' : '') + '>PC</option>' +
                        '<option value="ë…¸íŠ¸ë¶"' + (item.changes.assetType === 'ë…¸íŠ¸ë¶' ? ' selected' : '') + '>ë…¸íŠ¸ë¶</option>' +
                        '<option value="ëª¨ë‹ˆí„°"' + (item.changes.assetType === 'ëª¨ë‹ˆí„°' ? ' selected' : '') + '>ëª¨ë‹ˆí„°</option>' +
                        '<option value="í”„ë¦°í„°"' + (item.changes.assetType === 'í”„ë¦°í„°' ? ' selected' : '') + '>í”„ë¦°í„°</option>' +
                        '<option value="ê¸°íƒ€"' + (item.changes.assetType === 'ê¸°íƒ€' ? ' selected' : '') + '>ê¸°íƒ€</option>' +
                    '</select></div>';
            }

            return html;
        }

        function updateItemChange(idx, field) {
            var item = scannedItems[idx];
            if (field === 'dept') {
                var deptCode = document.getElementById('deptSelect' + idx).value;
                if (deptCode) {
                    item.changes.deptCode = deptCode;
                    item.changes.dept = MOCK_DEPARTMENTS[deptCode].name;
                } else {
                    delete item.changes.deptCode;
                    delete item.changes.dept;
                }
            } else if (field === 'status') {
                var status = document.getElementById('statusSelect' + idx).value;
                if (status) {
                    item.changes.status = status;
                    item.changes.statusCode = getStatusCode(status);
                } else {
                    delete item.changes.status;
                    delete item.changes.statusCode;
                }
            } else if (field === 'assetType') {
                var type = document.getElementById('typeSelect' + idx).value;
                if (type) item.changes.assetType = type;
                else delete item.changes.assetType;
            }
        }

        function toggleItemCheck(idx) {
            scannedItems[idx].checked = !scannedItems[idx].checked;
            updateUI();
        }

        function toggleItemExpand(idx) {
            var el = document.getElementById('item' + idx);
            el.classList.toggle('expanded');
        }

        function deleteItem(idx) {
            scannedItems.splice(idx, 1);
            updateUI();
            showToast('ì‚­ì œë¨');
        }

        function toggleSelectAll() {
            var allChecked = scannedItems.every(function(i) { return i.checked; });
            scannedItems.forEach(function(i) { i.checked = !allChecked; });
            updateUI();
        }

        // ===== Batch Action Modal =====
        function openBatchModal() {
            var checkedItems = scannedItems.filter(function(i) { return i.checked; });
            if (checkedItems.length === 0) {
                showToast('ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            var content = document.getElementById('batchModalContent');
            var html = '<div class="modal-header">' +
                '<span class="modal-title">ì¼ê´„ ì‘ì—… (' + checkedItems.length + 'ê±´)</span>' +
                '<button class="modal-close" onclick="closeBatchModal()">Ã—</button></div>';

            html += '<div class="batch-section">' +
                '<div class="batch-label">ë¶€ì„œ ì¼ê´„ ë³€ê²½</div>' +
                '<select class="expand-select" id="batchDept">' +
                    '<option value="">ë³€ê²½ ì•ˆ í•¨</option>';
            Object.values(MOCK_DEPARTMENTS).forEach(function(d) {
                var selected = (currentDeptCode === d.code) ? ' selected' : '';
                html += '<option value="' + d.code + '"' + selected + '>' + d.name + ' (í˜„ì¬ ìœ„ì¹˜)</option>';
            });
            html += '</select></div>';

            html += '<div class="batch-section">' +
                '<div class="batch-label">ìƒíƒœ ì¼ê´„ ë³€ê²½</div>' +
                '<div class="batch-options">' +
                    '<button class="batch-option" onclick="selectBatchStatus(this, \'\')" >ë³€ê²½ ì•ˆ í•¨</button>' +
                    '<button class="batch-option" onclick="selectBatchStatus(this, \'ì ê²€ì™„ë£Œ\')">ì ê²€ì™„ë£Œ</button>' +
                    '<button class="batch-option" onclick="selectBatchStatus(this, \'ìˆ˜ë¦¬ì™„ë£Œ\')">ìˆ˜ë¦¬ì™„ë£Œ</button>' +
                    '<button class="batch-option" onclick="selectBatchStatus(this, \'ì •ìƒ\')">ì •ìƒ</button>' +
                '</div>' +
                '<input type="hidden" id="batchStatus" value="">' +
            '</div>';

            var hasNeedsInput = checkedItems.some(function(i) { return i.needsInput; });
            if (hasNeedsInput) {
                html += '<div style="padding:10px;background:var(--sju-warning-bg);border-radius:6px;font-size:12px;color:#92400e;margin-bottom:12px;">' +
                    'âš ï¸ ë¯¸ë“±ë¡/ë‚©í’ˆ í•­ëª©ì€ ê°œë³„ ë“±ë¡ ì •ë³´ ì…ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤</div>';
            }

            html += '<div class="modal-actions">' +
                '<button class="modal-btn secondary" onclick="closeBatchModal()">ì·¨ì†Œ</button>' +
                '<button class="modal-btn primary" onclick="applyBatchAction()">ì ìš©</button>' +
            '</div>';

            content.innerHTML = html;
            document.getElementById('batchModal').classList.add('active');
        }

        function selectBatchStatus(btn, status) {
            document.querySelectorAll('#batchModalContent .batch-option').forEach(function(b) {
                b.classList.remove('selected');
            });
            btn.classList.add('selected');
            document.getElementById('batchStatus').value = status;
        }

        function applyBatchAction() {
            var deptCode = document.getElementById('batchDept').value;
            var status = document.getElementById('batchStatus').value;

            var applied = 0;
            scannedItems.forEach(function(item) {
                if (item.checked) {
                    if (deptCode) {
                        item.changes.deptCode = deptCode;
                        item.changes.dept = MOCK_DEPARTMENTS[deptCode].name;
                    }
                    if (status) {
                        item.changes.status = status;
                        item.changes.statusCode = getStatusCode(status);
                    }
                    applied++;
                }
            });

            closeBatchModal();
            updateUI();
            showToast(applied + 'ê±´ ì¼ê´„ ì ìš©ë¨');
        }

        function closeBatchModal() {
            document.getElementById('batchModal').classList.remove('active');
        }

        // ===== Commit Modal =====
        function openCommitModal() {
            if (scannedItems.length === 0) {
                showToast('ì²˜ë¦¬í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            var errors = [];
            scannedItems.forEach(function(item) {
                if (item.needsInput && !item.changes.assetType) {
                    errors.push(item.serial + ': ì¥ë¹„ ìœ í˜• ì…ë ¥ í•„ìš”');
                }
            });

            if (errors.length > 0) {
                showToast(errors[0]);
                return;
            }

            var content = document.getElementById('commitModalContent');
            var html = '<div class="modal-header">' +
                '<span class="modal-title">ì ê²€ ì™„ë£Œ í™•ì¸</span>' +
                '<button class="modal-close" onclick="closeCommitModal()">Ã—</button></div>';

            html += '<div style="margin-bottom:12px;font-size:13px;color:var(--sju-gray-700);">ì´ ' + scannedItems.length + 'ê±´ì˜ ë³€ê²½ì‚¬í•­ì„ ì €ì¥í•©ë‹ˆë‹¤.</div>';

            html += '<div class="commit-summary">';
            scannedItems.forEach(function(item) {
                var action = getCommitAction(item);
                html += '<div class="commit-item">' +
                    '<span class="commit-item-serial">' + item.serial + '</span>' +
                    '<span class="commit-item-action">' + action + '</span>' +
                '</div>';
            });
            html += '</div>';

            html += '<div class="modal-actions">' +
                '<button class="modal-btn secondary" onclick="closeCommitModal()">ì·¨ì†Œ</button>' +
                '<button class="modal-btn primary" onclick="executeCommit()">ì™„ë£Œ</button>' +
            '</div>';

            content.innerHTML = html;
            document.getElementById('commitModal').classList.add('active');
        }

        function getCommitAction(item) {
            var actions = [];
            if (item.changes.dept) actions.push('ë¶€ì„œâ†’' + item.changes.dept);
            if (item.changes.status) actions.push('ìƒíƒœâ†’' + item.changes.status);
            if (item.needsInput) actions.push('ì‹ ê·œë“±ë¡');
            if (actions.length === 0) actions.push('ì ê²€í™•ì¸');
            return actions.join(', ');
        }

        function executeCommit() {
            console.log('Committing items:', scannedItems);

            closeCommitModal();
            showToast('ì ê²€ ì™„ë£Œ! ' + scannedItems.length + 'ê±´ ì²˜ë¦¬ë¨');

            setTimeout(function() {
                scannedItems = [];
                updateUI();
            }, 1500);
        }

        function closeCommitModal() {
            document.getElementById('commitModal').classList.remove('active');
        }

        // ===== Helper Functions =====
        function getStatusText(caseType, data) {
            switch (caseType) {
                case 'A1-1': return 'âœ“ ì •ìƒ (' + (data ? data.dept : '') + ')';
                case 'A1-2': return 'ğŸ”§ ìˆ˜ë¦¬ì¤‘';
                case 'A1-3': return 'âš ï¸ íê¸°ë¨';
                case 'A1-4': return 'ğŸ” ë¶„ì‹¤';
                case 'A2-1': return 'â†’ ì´ë™ í•„ìš” (' + (data ? data.dept : '') + ')';
                case 'A2-2': return 'â†’ ì´ë™+ìˆ˜ë¦¬ì¤‘';
                case 'A2-3': return 'â†’ ì´ë™+íê¸°';
                case 'A2-4': return 'â†’ ì´ë™+ë¶„ì‹¤';
                case 'B1': return 'ğŸ“¦ ë‚©í’ˆ ëŒ€ê¸°';
                case 'C1': return 'â“ ë¯¸ë“±ë¡';
                default: return 'í™•ì¸ í•„ìš”';
            }
        }

        function getStatusIcon(caseType) {
            switch (caseType) {
                case 'A1-1': return 'âœ“';
                case 'A1-2': case 'A2-2': return 'ğŸ”§';
                case 'A1-3': case 'A2-3': return 'âš ï¸';
                case 'A1-4': case 'A2-4': return 'ğŸ”';
                case 'A2-1': return 'â†’';
                case 'B1': return 'ğŸ“¦';
                case 'C1': return 'â“';
                default: return '?';
            }
        }

        function getStatusClass(caseType) {
            switch (caseType) {
                case 'A1-1': return 'ok';
                case 'A1-2': case 'A2-2': return 'warning';
                case 'A1-3': case 'A2-3': return 'danger';
                case 'A1-4': case 'A2-4': return 'warning';
                case 'A2-1': return 'move';
                case 'B1': case 'C1': return 'new';
                default: return 'pending';
            }
        }

        function getBadge(item) {
            if (item.changes.status) {
                return { class: 'badge-ok', text: item.changes.status };
            }
            switch (item.caseType) {
                case 'A1-1': return { class: 'badge-ok', text: 'ì •ìƒ' };
                case 'A1-2': return { class: 'badge-repair', text: 'ìˆ˜ë¦¬ì¤‘' };
                case 'A1-3': return { class: 'badge-dispose', text: 'íê¸°' };
                case 'A1-4': return { class: 'badge-lost', text: 'ë¶„ì‹¤' };
                case 'A2-1': return { class: 'badge-move', text: 'ì´ë™' };
                case 'A2-2': return { class: 'badge-move', text: 'ì´ë™+ìˆ˜ë¦¬' };
                case 'A2-3': return { class: 'badge-move', text: 'ì´ë™+íê¸°' };
                case 'A2-4': return { class: 'badge-move', text: 'ì´ë™+ë¶„ì‹¤' };
                case 'B1': return { class: 'badge-delivery', text: 'ë‚©í’ˆ' };
                case 'C1': return { class: 'badge-new', text: 'ë¯¸ë“±ë¡' };
                default: return { class: 'badge-unregistered', text: 'í™•ì¸í•„ìš”' };
            }
        }

        function getDetail(item) {
            var parts = [];
            if (item.original) {
                parts.push(item.original.model || '');
                if (item.changes.dept) {
                    parts.push(item.original.dept + 'â†’' + item.changes.dept);
                } else {
                    parts.push(item.original.dept || '');
                }
            } else {
                parts.push('ë¯¸ë“±ë¡');
                if (item.changes.assetType) parts.push(item.changes.assetType);
            }
            return parts.filter(Boolean).join(' | ');
        }

        function shouldAutoExpand(caseType) {
            return ['A1-2', 'A1-3', 'A1-4', 'A2-2', 'A2-3', 'A2-4', 'B1', 'C1'].indexOf(caseType) >= 0;
        }

        function needsStatusChange(caseType) {
            return ['A1-2', 'A1-3', 'A1-4', 'A2-2', 'A2-3', 'A2-4'].indexOf(caseType) >= 0;
        }

        function getStatusOptions(item) {
            var html = '<option value="">ë³€ê²½ ì•ˆ í•¨</option>';
            var current = item.changes.status || '';

            switch (item.caseType) {
                case 'A1-2': case 'A2-2':
                    html += '<option value="ìˆ˜ë¦¬ì™„ë£Œ"' + (current === 'ìˆ˜ë¦¬ì™„ë£Œ' ? ' selected' : '') + '>ìˆ˜ë¦¬ì™„ë£Œ</option>';
                    html += '<option value="ìˆ˜ë¦¬ì¤‘ ìœ ì§€"' + (current === 'ìˆ˜ë¦¬ì¤‘ ìœ ì§€' ? ' selected' : '') + '>ìˆ˜ë¦¬ì¤‘ ìœ ì§€</option>';
                    break;
                case 'A1-3': case 'A2-3':
                    html += '<option value="íê¸° í™•ì¸"' + (current === 'íê¸° í™•ì¸' ? ' selected' : '') + '>íê¸° í™•ì¸ (ìœ ì§€)</option>';
                    html += '<option value="ì •ìƒ"' + (current === 'ì •ìƒ' ? ' selected' : '') + '>ì •ìƒìœ¼ë¡œ ë³€ê²½</option>';
                    break;
                case 'A1-4': case 'A2-4':
                    html += '<option value="ë¶„ì‹¤ ë³µêµ¬"' + (current === 'ë¶„ì‹¤ ë³µêµ¬' ? ' selected' : '') + '>ë¶„ì‹¤ ë³µêµ¬ (ì •ìƒ)</option>';
                    html += '<option value="ë¶„ì‹¤ ìœ ì§€"' + (current === 'ë¶„ì‹¤ ìœ ì§€' ? ' selected' : '') + '>ë¶„ì‹¤ ìœ ì§€</option>';
                    break;
            }
            return html;
        }

        function getStatusCode(status) {
            switch (status) {
                case 'ì •ìƒ': case 'ìˆ˜ë¦¬ì™„ë£Œ': case 'ë¶„ì‹¤ ë³µêµ¬': case 'ì ê²€ì™„ë£Œ': return 'N';
                case 'ìˆ˜ë¦¬ì¤‘': case 'ìˆ˜ë¦¬ì¤‘ ìœ ì§€': return 'R';
                case 'íê¸°': case 'íê¸° í™•ì¸': return 'D';
                case 'ë¶„ì‹¤': case 'ë¶„ì‹¤ ìœ ì§€': return 'L';
                default: return 'N';
            }
        }

        // ===== Utilities =====
        function showToast(msg) {
            var toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(function() { toast.classList.remove('show'); }, 2000);
        }

        function showLoading(show, text) {
            document.getElementById('loadingOverlay').classList.toggle('active', show);
            if (text) document.getElementById('loadingText').textContent = text;
        }

        function resizeImage(file, maxWidth) {
            return new Promise(function(resolve) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var img = new Image();
                    img.onload = function() {
                        var canvas = document.createElement('canvas');
                        var w = img.width, h = img.height;
                        if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        var dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                        resolve({ dataUrl: dataUrl, base64: dataUrl.split(',')[1] });
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function callVisionAPI(base64, apiKey) {
            var resp = await fetch('https://vision.googleapis.com/v1/images:annotate?key=' + apiKey, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    requests: [{ image: { content: base64 }, features: [{ type: 'TEXT_DETECTION' }] }]
                })
            });
            var data = await resp.json();
            if (data.error) throw new Error(data.error.message);
            var ta = data.responses[0] && data.responses[0].textAnnotations;
            return ta && ta.length > 0 ? ta[0].description : null;
        }

        function extractSerials(text) {
            if (!text) return [];
            var exclude = /^(number|serial|model|part|product|type|version|no|sn|id|null|test)$/i;
            var candidates = [];
            var patterns = [
                /\b(\d{2,3}LG[A-Z]\d[A-Z][A-Z0-9]{10,})\b/gi,
                /\b(G[12]L\d{3}E\d{5}-\d{5})\b/gi,
                /\b(TAG-?N\d+[A-Z]+\d+-[A-Z]?\d+)\b/gi,
                /\b(CW[A-Z0-9]{2,4}H[0-9][A-Z]{2}[A-Z0-9]{6,})\b/gi,
                /\b(LED\d{10}[A-Z]\d)\b/gi,
                /\b([A-Z]{2,4}\d{2,4}[A-Z0-9]{6,})\b/gi,
                /\b(\d{3}[A-Z]{2,4}[A-Z0-9]{6,})\b/gi
            ];
            patterns.forEach(function(p) {
                var m = text.match(p);
                if (m) m.forEach(function(s) {
                    if (!exclude.test(s) && s.length >= 10) candidates.push(s);
                });
            });
            var unique = [], seen = {};
            candidates.forEach(function(c) { if (!seen[c]) { seen[c] = true; unique.push(c); } });
            return unique.slice(0, 5);
        }

        // ===== Cleanup on page unload =====
        window.addEventListener('beforeunload', function() {
            stopScanner();
        });
    </script>
</body>
</html>
