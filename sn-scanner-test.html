<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>S/N ìŠ¤ìº” í…ŒìŠ¤íŠ¸</title>
    
    <!-- PWA ì„¤ì • -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- QR ìŠ¤ìºë„ˆ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <!-- Tesseract OCR (ë¡œì»¬ OCR) -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Malgun Gothic', sans-serif;
            background: #1a1a2e;
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            font-size: 20px;
            margin-bottom: 20px;
            color: #4ecca3;
        }
        
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-btn.active {
            background: #4ecca3;
            color: #1a1a2e;
        }
        
        .tab-btn:not(.active) {
            background: #2d2d44;
            color: #888;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* ìŠ¤ìºë„ˆ ì˜ì—­ */
        .scanner-container {
            background: #2d2d44;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        #qr-reader {
            width: 100%;
        }
        
        #qr-reader video {
            border-radius: 12px;
        }
        
        /* OCR ì˜ì—­ */
        .ocr-section {
            background: #2d2d44;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .capture-btn {
            width: 100%;
            padding: 15px;
            background: #4ecca3;
            color: #1a1a2e;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 15px;
        }
        
        .capture-btn:disabled {
            background: #555;
            color: #888;
        }
        
        #camera-preview {
            width: 100%;
            border-radius: 8px;
            display: none;
        }
        
        #captured-image {
            width: 100%;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }
        
        .file-input-wrapper {
            margin-top: 10px;
        }
        
        .file-input-wrapper input {
            display: none;
        }
        
        .file-input-label {
            display: block;
            padding: 12px;
            background: #3d3d5c;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* ê²°ê³¼ ì˜ì—­ */
        .result-section {
            background: #2d2d44;
            border-radius: 12px;
            padding: 20px;
        }
        
        .result-title {
            font-size: 14px;
            color: #888;
            margin-bottom: 10px;
        }
        
        .result-value {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 24px;
            color: #4ecca3;
            padding: 15px;
            background: #1a1a2e;
            border-radius: 8px;
            text-align: center;
            word-break: break-all;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .result-value.error {
            color: #ff6b6b;
            font-size: 16px;
        }
        
        .result-value.processing {
            color: #ffd93d;
            font-size: 16px;
        }
        
        /* ì•¡ì…˜ ë²„íŠ¼ */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .action-btn.primary {
            background: #4ecca3;
            color: #1a1a2e;
        }
        
        .action-btn.secondary {
            background: #3d3d5c;
            color: #fff;
        }
        
        .action-btn.danger {
            background: #ff6b6b;
            color: #fff;
        }
        
        /* íˆìŠ¤í† ë¦¬ */
        .history-section {
            margin-top: 20px;
            background: #2d2d44;
            border-radius: 12px;
            padding: 15px;
        }
        
        .history-title {
            font-size: 14px;
            color: #888;
            margin-bottom: 10px;
        }
        
        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #1a1a2e;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .history-item:last-child {
            margin-bottom: 0;
        }
        
        .history-serial {
            font-family: 'Consolas', monospace;
            color: #4ecca3;
        }
        
        .history-time {
            color: #666;
            font-size: 11px;
        }
        
        /* ë¡œë”© */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #4ecca3;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ì•ˆë‚´ ë¬¸êµ¬ */
        .guide-text {
            font-size: 12px;
            color: #888;
            text-align: center;
            margin-top: 10px;
            line-height: 1.6;
        }
        
        /* ìˆ˜ë™ ì…ë ¥ */
        .manual-input {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .manual-input input {
            flex: 1;
            padding: 12px;
            border: 1px solid #3d3d5c;
            border-radius: 8px;
            background: #1a1a2e;
            color: #fff;
            font-size: 14px;
            font-family: 'Consolas', monospace;
        }
        
        .manual-input input:focus {
            outline: none;
            border-color: #4ecca3;
        }
        
        .manual-input button {
            padding: 12px 20px;
            background: #4ecca3;
            color: #1a1a2e;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“· S/N ìŠ¤ìº” í…ŒìŠ¤íŠ¸</h1>
        
        <!-- íƒ­ ë²„íŠ¼ -->
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('qr')">QR ìŠ¤ìº”</button>
            <button class="tab-btn" onclick="switchTab('ocr')">S/N ì´¬ì˜ (OCR)</button>
        </div>
        
        <!-- QR ìŠ¤ìº” íƒ­ -->
        <div id="tab-qr" class="tab-content active">
            <div class="scanner-container">
                <div id="qr-reader"></div>
            </div>
            <p class="guide-text">
                QR ì½”ë“œë¥¼ ì¹´ë©”ë¼ì— ë¹„ì¶”ë©´ ìë™ìœ¼ë¡œ ì¸ì‹ë©ë‹ˆë‹¤.<br>
                (í…ŒìŠ¤íŠ¸ìš©: ì•„ë¬´ QR ì½”ë“œë‚˜ ìŠ¤ìº”í•´ë³´ì„¸ìš”)
            </p>
        </div>
        
        <!-- OCR íƒ­ -->
        <div id="tab-ocr" class="tab-content">
            <div class="ocr-section">
                <button class="capture-btn" id="startCameraBtn" onclick="startCamera()">
                    ğŸ“· ì¹´ë©”ë¼ ì¼œê¸°
                </button>
                
                <video id="camera-preview" autoplay playsinline></video>
                
                <button class="capture-btn" id="captureBtn" style="display:none;" onclick="capturePhoto()">
                    ğŸ“¸ ì´¬ì˜í•˜ê¸°
                </button>
                
                <img id="captured-image" alt="ì´¬ì˜ëœ ì´ë¯¸ì§€">
                
                <div class="file-input-wrapper">
                    <label class="file-input-label" for="file-input">
                        ğŸ“ ë˜ëŠ” ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒ
                    </label>
                    <input type="file" id="file-input" accept="image/*" onchange="handleFileSelect(event)">
                </div>
            </div>
            
            <p class="guide-text">
                ì‹œë¦¬ì–¼ ë²ˆí˜¸ê°€ ì˜ ë³´ì´ë„ë¡ ì´¬ì˜í•˜ì„¸ìš”.<br>
                ê¸€ìê°€ ì„ ëª…í• ìˆ˜ë¡ ì¸ì‹ë¥ ì´ ë†’ì•„ì§‘ë‹ˆë‹¤.
            </p>
        </div>
        
        <!-- ê²°ê³¼ ì˜ì—­ -->
        <div class="result-section">
            <div class="result-title">ì¸ì‹ ê²°ê³¼</div>
            <div class="result-value" id="result">
                ìŠ¤ìº” ëŒ€ê¸° ì¤‘...
            </div>
            
            <!-- ì¸ì‹ ì„±ê³µ ì‹œ í‘œì‹œë  ë²„íŠ¼ -->
            <div class="action-buttons" id="actionButtons" style="display:none;">
                <button class="action-btn primary" onclick="handleAction('check')">âœ… ì ê²€ì™„ë£Œ</button>
                <button class="action-btn secondary" onclick="handleAction('repair')">ğŸ”§ ìˆ˜ë¦¬ì ‘ìˆ˜</button>
                <button class="action-btn danger" onclick="handleAction('new')">â• ì‹ ê·œë“±ë¡</button>
            </div>
            
            <!-- ìˆ˜ë™ ì…ë ¥ -->
            <div class="manual-input">
                <input type="text" id="manualInput" placeholder="ìˆ˜ë™ ì…ë ¥ (S/N)">
                <button onclick="handleManualInput()">í™•ì¸</button>
            </div>
        </div>
        
        <!-- ìŠ¤ìº” íˆìŠ¤í† ë¦¬ -->
        <div class="history-section">
            <div class="history-title">ìŠ¤ìº” ê¸°ë¡</div>
            <div class="history-list" id="historyList">
                <div style="color:#666; text-align:center; padding:20px;">
                    ì•„ì§ ìŠ¤ìº” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let html5QrcodeScanner = null;
        let cameraStream = null;
        let scanHistory = [];
        
        // ===== íƒ­ ì „í™˜ =====
        function switchTab(tab) {
            // íƒ­ ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`).classList.add('active');
            
            // íƒ­ ì½˜í…ì¸  ì „í™˜
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            // QR ìŠ¤ìºë„ˆ ì œì–´
            if (tab === 'qr') {
                startQrScanner();
                stopCamera();
            } else {
                stopQrScanner();
            }
        }
        
        // ===== QR ìŠ¤ìº” =====
        function startQrScanner() {
            if (html5QrcodeScanner) return;
            
            html5QrcodeScanner = new Html5Qrcode("qr-reader");
            
            html5QrcodeScanner.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                onQrCodeSuccess,
                onQrCodeError
            ).catch(err => {
                console.error("QR ìŠ¤ìºë„ˆ ì‹œì‘ ì‹¤íŒ¨:", err);
                showResult("ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤", "error");
            });
        }
        
        function stopQrScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner = null;
                }).catch(err => console.log(err));
            }
        }
        
        function onQrCodeSuccess(decodedText, decodedResult) {
            // QR ì¸ì‹ ì„±ê³µ
            console.log("QR ì¸ì‹:", decodedText);
            
            // ì§„ë™ í”¼ë“œë°± (ì§€ì›ë˜ëŠ” ê²½ìš°)
            if (navigator.vibrate) {
                navigator.vibrate(100);
            }
            
            // ê²°ê³¼ í‘œì‹œ
            showResult(decodedText, "success");
            addToHistory(decodedText, "QR");
            
            // ì ì‹œ ë©ˆì¶¤ (ì¤‘ë³µ ìŠ¤ìº” ë°©ì§€)
            stopQrScanner();
            setTimeout(() => {
                if (document.getElementById('tab-qr').classList.contains('active')) {
                    startQrScanner();
                }
            }, 2000);
        }
        
        function onQrCodeError(error) {
            // ì¸ì‹ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ (ê³„ì† ìŠ¤ìº”)
        }
        
        // ===== OCR (ì‚¬ì§„ ì´¬ì˜) =====
        async function startCamera() {
            try {
                const video = document.getElementById('camera-preview');
                const startBtn = document.getElementById('startCameraBtn');
                const captureBtn = document.getElementById('captureBtn');
                
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1280 } }
                });
                
                video.srcObject = cameraStream;
                video.style.display = 'block';
                startBtn.style.display = 'none';
                captureBtn.style.display = 'block';
                
            } catch (err) {
                console.error("ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:", err);
                showResult("ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤", "error");
            }
        }
        
        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            const video = document.getElementById('camera-preview');
            const startBtn = document.getElementById('startCameraBtn');
            const captureBtn = document.getElementById('captureBtn');
            
            video.style.display = 'none';
            startBtn.style.display = 'block';
            captureBtn.style.display = 'none';
        }
        
        function capturePhoto() {
            const video = document.getElementById('camera-preview');
            const capturedImage = document.getElementById('captured-image');
            
            // ìº”ë²„ìŠ¤ì— ë¹„ë””ì˜¤ í”„ë ˆì„ ìº¡ì²˜
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            // ì´ë¯¸ì§€ë¡œ ë³€í™˜
            const imageDataUrl = canvas.toDataURL('image/jpeg', 0.8);
            capturedImage.src = imageDataUrl;
            capturedImage.style.display = 'block';
            
            // ì¹´ë©”ë¼ ë„ê¸°
            stopCamera();
            
            // OCR ì‹¤í–‰
            runOCR(imageDataUrl);
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const capturedImage = document.getElementById('captured-image');
                capturedImage.src = e.target.result;
                capturedImage.style.display = 'block';
                
                // OCR ì‹¤í–‰
                runOCR(e.target.result);
            };
            reader.readAsDataURL(file);
        }
        
        async function runOCR(imageSource) {
            showResult('<span class="loading"></span> OCR ë¶„ì„ ì¤‘...', "processing");
            
            try {
                const result = await Tesseract.recognize(imageSource, 'eng', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const progress = Math.round(m.progress * 100);
                            showResult(`<span class="loading"></span> ë¶„ì„ ì¤‘... ${progress}%`, "processing");
                        }
                    }
                });
                
                const text = result.data.text;
                console.log("OCR ì›ë³¸ ê²°ê³¼:", text);
                
                // ì‹œë¦¬ì–¼ ë²ˆí˜¸ íŒ¨í„´ ì¶”ì¶œ
                const serialNumber = extractSerialNumber(text);
                
                if (serialNumber) {
                    showResult(serialNumber, "success");
                    addToHistory(serialNumber, "OCR");
                } else {
                    showResult("ì‹œë¦¬ì–¼ ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤\nìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”", "error");
                }
                
            } catch (err) {
                console.error("OCR ì˜¤ë¥˜:", err);
                showResult("OCR ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤", "error");
            }
        }
        
        // ===== ì‹œë¦¬ì–¼ ë²ˆí˜¸ ì¶”ì¶œ (ì •ê·œí‘œí˜„ì‹) =====
        function extractSerialNumber(text) {
            // ì¼ë°˜ì ì¸ ì‹œë¦¬ì–¼ ë²ˆí˜¸ íŒ¨í„´ë“¤
            const patterns = [
                // DELL: 7ìë¦¬ ì˜ìˆ«ì (ì˜ˆ: 9F3A21B)
                /\b[A-Z0-9]{7}\b/g,
                // HP: 10ìë¦¬ (ì˜ˆ: MXL1234ABC)
                /\b[A-Z]{3}[0-9]{4}[A-Z0-9]{3}\b/g,
                // ì‚¼ì„±/LG: S/N ë˜ëŠ” Serial ë’¤ì˜ ê°’
                /(?:S\/N|Serial|SN)[\s:]*([A-Z0-9-]{6,20})/gi,
                // ì¼ë°˜ì ì¸ íŒ¨í„´: ì˜ë¬¸+ìˆ«ì ì¡°í•© 8~15ìë¦¬
                /\b[A-Z]{2,4}[-]?[A-Z0-9]{4,12}\b/g,
                // ìˆ«ìë§Œ 10ìë¦¬ ì´ìƒ
                /\b[0-9]{10,15}\b/g
            ];
            
            // í…ìŠ¤íŠ¸ ì „ì²˜ë¦¬
            const cleanText = text.toUpperCase().replace(/[^A-Z0-9\s\-:\/]/g, ' ');
            
            for (const pattern of patterns) {
                const matches = cleanText.match(pattern);
                if (matches && matches.length > 0) {
                    // S/N: í˜•íƒœë©´ ë’¤ì˜ ê°’ë§Œ ì¶”ì¶œ
                    let serial = matches[0];
                    if (serial.includes('S/N') || serial.includes('SERIAL') || serial.includes('SN')) {
                        serial = serial.replace(/.*(?:S\/N|SERIAL|SN)[\s:]*/i, '');
                    }
                    
                    // ìµœì†Œ ê¸¸ì´ ì²´í¬
                    if (serial.length >= 6) {
                        return serial.trim();
                    }
                }
            }
            
            return null;
        }
        
        // ===== ê²°ê³¼ í‘œì‹œ =====
        function showResult(text, type = "normal") {
            const resultEl = document.getElementById('result');
            const actionButtons = document.getElementById('actionButtons');
            
            resultEl.innerHTML = text;
            resultEl.className = 'result-value';
            
            if (type === 'error') {
                resultEl.classList.add('error');
                actionButtons.style.display = 'none';
            } else if (type === 'processing') {
                resultEl.classList.add('processing');
                actionButtons.style.display = 'none';
            } else if (type === 'success') {
                actionButtons.style.display = 'flex';
            }
        }
        
        // ===== ìˆ˜ë™ ì…ë ¥ =====
        function handleManualInput() {
            const input = document.getElementById('manualInput');
            const value = input.value.trim().toUpperCase();
            
            if (value.length >= 4) {
                showResult(value, "success");
                addToHistory(value, "ìˆ˜ë™");
                input.value = '';
            } else {
                alert("ìµœì†Œ 4ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”");
            }
        }
        
        // ===== ì•¡ì…˜ ì²˜ë¦¬ =====
        function handleAction(action) {
            const serial = document.getElementById('result').innerText;
            
            switch(action) {
                case 'check':
                    alert(`âœ… ì ê²€ì™„ë£Œ ì²˜ë¦¬\n\nS/N: ${serial}\n\n(ì‹¤ì œë¡œëŠ” ì„œë²„ì— ì „ì†¡ë©ë‹ˆë‹¤)`);
                    break;
                case 'repair':
                    alert(`ğŸ”§ ìˆ˜ë¦¬ì ‘ìˆ˜ ì²˜ë¦¬\n\nS/N: ${serial}\n\n(ì‹¤ì œë¡œëŠ” ìˆ˜ë¦¬ì ‘ìˆ˜ í™”ë©´ìœ¼ë¡œ ì´ë™)`);
                    break;
                case 'new':
                    alert(`â• ì‹ ê·œë“±ë¡ ì²˜ë¦¬\n\nS/N: ${serial}\n\n(ì‹¤ì œë¡œëŠ” ë“±ë¡ í™”ë©´ìœ¼ë¡œ ì´ë™)`);
                    break;
            }
        }
        
        // ===== íˆìŠ¤í† ë¦¬ =====
        function addToHistory(serial, method) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            scanHistory.unshift({ serial, method, time: timeStr });
            
            // ìµœëŒ€ 20ê°œê¹Œì§€ë§Œ ìœ ì§€
            if (scanHistory.length > 20) {
                scanHistory.pop();
            }
            
            renderHistory();
        }
        
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            
            if (scanHistory.length === 0) {
                historyList.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">ì•„ì§ ìŠ¤ìº” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            historyList.innerHTML = scanHistory.map(item => `
                <div class="history-item">
                    <span class="history-serial">${item.serial}</span>
                    <span>
                        <span style="background:#3d3d5c; padding:2px 6px; border-radius:4px; font-size:10px; margin-right:5px;">${item.method}</span>
                        <span class="history-time">${item.time}</span>
                    </span>
                </div>
            `).join('');
        }
        
        // ===== ì´ˆê¸°í™” =====
        document.addEventListener('DOMContentLoaded', function() {
            startQrScanner();
            
            // Enter í‚¤ë¡œ ìˆ˜ë™ ì…ë ¥
            document.getElementById('manualInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleManualInput();
                }
            });
        });
        
        // í˜ì´ì§€ ë– ë‚  ë•Œ ì •ë¦¬
        window.addEventListener('beforeunload', function() {
            stopQrScanner();
            stopCamera();
        });
    </script>
</body>
</html>
