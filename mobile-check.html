<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìì‚° ì ê²€</title>
    <style>
        /* ===== SJU Design System Variables ===== */
        :root {
            --sju-primary: #11306E;
            --sju-primary-hover: #0a1f4a;
            --sju-accent: #E6007E;
            --sju-success: #00978E;
            --sju-success-bg: #e0f2f1;
            --sju-warning: #f59e0b;
            --sju-warning-bg: #fef3c7;
            --sju-danger: #ef4444;
            --sju-danger-bg: #fee2e2;
            --sju-gray-100: #f5f5f5;
            --sju-gray-200: #eeeeee;
            --sju-gray-300: #e0e0e0;
            --sju-gray-500: #9e9e9e;
            --sju-gray-600: #757575;
            --sju-gray-700: #616161;
            --sju-gray-800: #424242;
            --sju-white: #ffffff;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Pretendard', 'Malgun Gothic', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--sju-gray-100);
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        /* ===== Header ===== */
        .header {
            background-color: var(--sju-primary);
            color: var(--sju-white);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title { font-size: 18px; font-weight: 600; }
        .header-count { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 13px; }

        /* ===== Location Bar ===== */
        .location-bar {
            background: var(--sju-white);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--sju-gray-200);
            cursor: pointer;
        }
        .location-bar:active { background: var(--sju-gray-100); }
        .location-icon { font-size: 18px; }
        .location-text { flex: 1; }
        .location-label { font-size: 11px; color: var(--sju-gray-500); }
        .location-value { font-size: 15px; font-weight: 500; color: var(--sju-gray-800); }
        .location-arrow { color: var(--sju-gray-500); font-size: 14px; }

        /* ===== Scan Area ===== */
        .scan-area {
            background: linear-gradient(135deg, var(--sju-primary) 0%, #1a4a9e 100%);
            margin: 16px;
            padding: 30px 20px;
            border-radius: var(--radius-lg);
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: var(--shadow-md);
        }
        .scan-area:active { transform: scale(0.98); }
        .scan-icon { font-size: 48px; margin-bottom: 12px; }
        .scan-text { color: var(--sju-white); font-size: 16px; font-weight: 500; }
        .scan-hint { color: rgba(255,255,255,0.7); font-size: 13px; margin-top: 8px; }

        /* ===== Results Section ===== */
        .results-section { padding: 0 16px 100px; }
        .results-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 4px; }
        .results-title { font-size: 14px; font-weight: 600; color: var(--sju-gray-700); }
        .results-count { font-size: 13px; color: var(--sju-gray-500); }

        /* ===== Result Item ===== */
        .result-item {
            background: var(--sju-white);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .result-item:active { background: var(--sju-gray-100); }
        .result-status {
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; flex-shrink: 0;
        }
        .result-status.ok { background: var(--sju-success-bg); }
        .result-status.move { background: #e0f2fe; }
        .result-status.warning { background: var(--sju-warning-bg); }
        .result-status.error { background: var(--sju-danger-bg); }
        .result-status.pending { background: var(--sju-gray-200); }
        .result-status.new { background: #ede9fe; }
        .result-info { flex: 1; min-width: 0; }
        .result-serial {
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px; font-weight: 600; color: var(--sju-gray-800);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .result-detail { font-size: 12px; color: var(--sju-gray-600); margin-top: 2px; }
        .result-badge { font-size: 11px; padding: 3px 8px; border-radius: 10px; font-weight: 500; white-space: nowrap; }
        .badge-ok { background: var(--sju-success-bg); color: var(--sju-success); }
        .badge-move { background: #e0f2fe; color: #0284c7; }
        .badge-repair { background: var(--sju-warning-bg); color: #d97706; }
        .badge-dispose { background: var(--sju-danger-bg); color: var(--sju-danger); }
        .badge-lost { background: #ffedd5; color: #ea580c; }
        .badge-delivery { background: #dbeafe; color: #2563eb; }
        .badge-unregistered { background: var(--sju-gray-200); color: var(--sju-gray-700); }
        .badge-registered { background: #ede9fe; color: #7c3aed; }

        /* ===== Empty State ===== */
        .empty-state { text-align: center; padding: 40px 20px; color: var(--sju-gray-500); }
        .empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
        .empty-text { font-size: 14px; }

        /* ===== Bottom Bar ===== */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--sju-white);
            padding: 12px 16px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            border-top: 1px solid var(--sju-gray-200);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .btn-complete {
            width: 100%; padding: 16px;
            background: var(--sju-primary); color: var(--sju-white);
            border: none; border-radius: var(--radius-md);
            font-size: 16px; font-weight: 600;
            cursor: pointer; transition: background 0.2s;
        }
        .btn-complete:active { background: var(--sju-primary-hover); }
        .btn-complete:disabled { background: #bdbdbd; cursor: not-allowed; }

        /* ===== Modal Overlay ===== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: flex-end;
            z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: var(--sju-white); width: 100%; max-height: 85vh;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            padding: 20px;
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            animation: slideUp 0.3s ease-out;
            overflow-y: auto;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-title { font-size: 18px; font-weight: 600; color: var(--sju-gray-800); }
        .modal-close {
            width: 32px; height: 32px; border: none;
            background: var(--sju-gray-100); border-radius: 50%;
            font-size: 20px; color: var(--sju-gray-600);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* ===== Department Select Modal ===== */
        .dept-list { max-height: 300px; overflow-y: auto; }
        .dept-item {
            padding: 14px 16px; border-bottom: 1px solid var(--sju-gray-200);
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .dept-item:active { background: var(--sju-gray-100); }
        .dept-item.selected { background: #e8f5e9; }
        .dept-name { font-size: 15px; color: var(--sju-gray-800); }
        .dept-location { font-size: 12px; color: var(--sju-gray-500); }

        /* ===== Case Popup Modal ===== */
        .case-info {
            background: var(--sju-gray-100); padding: 16px;
            border-radius: var(--radius-md); margin-bottom: 16px;
        }
        .case-serial {
            font-family: 'Consolas', monospace;
            font-size: 16px; font-weight: 600; color: var(--sju-primary); margin-bottom: 8px;
        }
        .case-detail { font-size: 13px; color: var(--sju-gray-700); line-height: 1.5; }
        .case-status-badge {
            display: inline-block; padding: 4px 10px; border-radius: 12px;
            font-size: 12px; font-weight: 500; margin-top: 8px;
        }
        .case-actions { display: flex; flex-direction: column; gap: 10px; }
        .case-btn {
            padding: 14px 16px; border: none; border-radius: var(--radius-md);
            font-size: 15px; font-weight: 500; cursor: pointer; text-align: center;
        }
        .case-btn.primary { background: var(--sju-primary); color: var(--sju-white); }
        .case-btn.secondary { background: var(--sju-gray-200); color: var(--sju-gray-700); }
        .case-btn.success { background: var(--sju-success); color: var(--sju-white); }
        .case-btn.warning { background: var(--sju-warning); color: var(--sju-white); }
        .case-btn.accent { background: var(--sju-accent); color: var(--sju-white); }

        /* ===== Form Styles ===== */
        .form-group { margin-bottom: 14px; }
        .form-label { display: block; font-size: 13px; color: var(--sju-gray-700); margin-bottom: 6px; font-weight: 500; }
        .form-input, .form-select {
            width: 100%; padding: 12px; border: 1px solid var(--sju-gray-300);
            border-radius: var(--radius-sm); font-size: 15px;
        }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--sju-primary); }

        /* ===== Multi Serial Select ===== */
        .serial-select-item {
            display: flex; align-items: center; gap: 12px;
            padding: 12px; border: 1px solid var(--sju-gray-300);
            border-radius: var(--radius-md); margin-bottom: 8px;
            cursor: pointer;
        }
        .serial-select-item.selected { border-color: var(--sju-primary); background: #e8f4fd; }
        .serial-select-item input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--sju-primary); }
        .serial-select-info { flex: 1; }
        .serial-select-sn { font-family: 'Consolas', monospace; font-size: 14px; font-weight: 600; }
        .serial-select-status { font-size: 12px; color: var(--sju-gray-600); margin-top: 2px; }

        /* ===== File Input Hidden ===== */
        .file-input-hidden { display: none; }

        /* ===== Toast ===== */
        .toast {
            position: fixed; bottom: 100px; left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0,0,0,0.8); color: var(--sju-white);
            padding: 12px 24px; border-radius: 24px; font-size: 14px;
            opacity: 0; transition: all 0.3s ease; z-index: 2000; pointer-events: none;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* ===== Loading Overlay ===== */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            display: none; justify-content: center; align-items: center; flex-direction: column;
            z-index: 3000;
        }
        .loading-overlay.active { display: flex; }
        .loading-spinner {
            width: 40px; height: 40px;
            border: 3px solid var(--sju-gray-200); border-top-color: var(--sju-primary);
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 16px; font-size: 14px; color: var(--sju-gray-600); }

        /* ===== API Key Section ===== */
        .api-section {
            background: var(--sju-white); margin: 16px; padding: 16px;
            border-radius: var(--radius-md); box-shadow: var(--shadow-sm);
        }
        .api-section label { font-size: 12px; color: var(--sju-gray-600); display: block; margin-bottom: 6px; }
        .api-section input {
            width: 100%; padding: 10px 12px;
            border: 1px solid var(--sju-gray-300); border-radius: var(--radius-sm); font-size: 14px;
        }
        .api-section input:focus { outline: none; border-color: var(--sju-primary); }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <span class="header-title">ìì‚° ì ê²€</span>
        <span class="header-count" id="headerCount">0ê±´</span>
    </div>

    <!-- Location Bar -->
    <div class="location-bar" onclick="openDeptModal()">
        <span class="location-icon">ğŸ“</span>
        <div class="location-text">
            <div class="location-label">í˜„ì¬ ì ê²€ ìœ„ì¹˜</div>
            <div class="location-value" id="currentDept">ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
        </div>
        <span class="location-arrow">â–¶</span>
    </div>

    <!-- API Key Section -->
    <div class="api-section">
        <label>Google Vision API Key</label>
        <input type="password" id="apiKey" placeholder="API Key ì…ë ¥...">
    </div>

    <!-- Scan Area -->
    <div class="scan-area" onclick="triggerScan()">
        <div class="scan-icon">ğŸ“·</div>
        <div class="scan-text">íƒ­í•˜ì—¬ ìŠ¤ìº”</div>
        <div class="scan-hint">ë¼ë²¨ì„ ì´¬ì˜í•˜ë©´ ìë™ìœ¼ë¡œ ì¸ì‹ë©ë‹ˆë‹¤</div>
    </div>
    <input type="file" id="fileInput" class="file-input-hidden" accept="image/*" capture="environment">

    <!-- Results Section -->
    <div class="results-section">
        <div class="results-header">
            <span class="results-title">ìŠ¤ìº” ê²°ê³¼</span>
            <span class="results-count" id="resultsCount">0ê±´</span>
        </div>
        <div id="resultsList">
            <div class="empty-state">
                <div class="empty-icon">ğŸ“‹</div>
                <div class="empty-text">ìŠ¤ìº”ëœ ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤</div>
            </div>
        </div>
    </div>

    <!-- Bottom Bar -->
    <div class="bottom-bar">
        <button class="btn-complete" id="btnComplete" disabled onclick="completeCheck()">
            ì ê²€ ì™„ë£Œ (0ê±´)
        </button>
    </div>

    <!-- Department Select Modal -->
    <div class="modal-overlay" id="deptModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">ì ê²€ ìœ„ì¹˜ ì„ íƒ</span>
                <button class="modal-close" onclick="closeDeptModal()">Ã—</button>
            </div>
            <div class="dept-list" id="deptList"></div>
        </div>
    </div>

    <!-- Case Popup Modal -->
    <div class="modal-overlay" id="caseModal">
        <div class="modal-content" id="caseModalContent"></div>
    </div>

    <!-- Multi Serial Select Modal -->
    <div class="modal-overlay" id="multiSerialModal">
        <div class="modal-content" id="multiSerialContent"></div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">ì¸ì‹ ì¤‘...</div>
    </div>

    <!-- Scripts -->
    <script src="js/mock-data.js"></script>
    <script>
        // ===== State =====
        var currentDeptCode = null;
        var scannedItems = [];
        var tempRegistrations = {}; // ê°„í¸ë“±ë¡ ì„ì‹œ ì €ì¥

        // ===== ì¥ë¹„ ìœ í˜•/ì œì¡°ì‚¬ ëª©ë¡ =====
        var ASSET_TYPES = ['PC', 'ë…¸íŠ¸ë¶', 'ëª¨ë‹ˆí„°', 'í”„ë¦°í„°', 'íƒœë¸”ë¦¿', 'ê¸°íƒ€'];
        var MANUFACTURERS = ['LG', 'Samsung', 'Dell', 'HP', 'Lenovo', 'Apple', 'ê¸°íƒ€'];

        // ===== Initialization =====
        document.addEventListener('DOMContentLoaded', function() {
            var savedKey = localStorage.getItem('google_vision_api_key');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
            }
            document.getElementById('apiKey').addEventListener('change', function() {
                localStorage.setItem('google_vision_api_key', this.value);
            });
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            initDeptList();
        });

        // ===== Department Functions =====
        async function initDeptList() {
            var depts = await getDepartments();
            var listEl = document.getElementById('deptList');
            listEl.innerHTML = depts.map(function(d) {
                return '<div class="dept-item" onclick="selectDept(\'' + d.code + '\')">' +
                    '<div><div class="dept-name">' + d.name + '</div>' +
                    '<div class="dept-location">' + d.building + ' ' + d.floor + '</div></div></div>';
            }).join('');
        }

        function openDeptModal() { document.getElementById('deptModal').classList.add('active'); }
        function closeDeptModal() { document.getElementById('deptModal').classList.remove('active'); }

        function selectDept(code) {
            currentDeptCode = code;
            var dept = MOCK_DEPARTMENTS[code];
            if (dept) {
                document.getElementById('currentDept').textContent = dept.building + ' > ' + dept.name;
            }
            closeDeptModal();
            showToast('ì ê²€ ìœ„ì¹˜: ' + dept.name);
        }

        // ===== Scan Functions =====
        function triggerScan() {
            if (!currentDeptCode) {
                showToast('ë¨¼ì € ì ê²€ ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”');
                openDeptModal();
                return;
            }
            var apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                showToast('API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            document.getElementById('fileInput').click();
        }

        async function handleFileSelect(e) {
            var file = e.target.files[0];
            if (!file) return;

            showLoading(true);

            try {
                var resized = await resizeImage(file, 1280);
                var apiKey = document.getElementById('apiKey').value;
                var text = await callVisionAPI(resized.base64, apiKey);

                if (!text) {
                    showToast('í…ìŠ¤íŠ¸ë¥¼ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
                    showLoading(false);
                    return;
                }

                var serials = extractSerials(text);
                if (serials.length === 0) {
                    showToast('ì‹œë¦¬ì–¼ ë²ˆí˜¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
                    showLoading(false);
                    return;
                }

                // ë‹¤ì¤‘ ì‹œë¦¬ì–¼ì¸ ê²½ìš° ì„ íƒ UI í‘œì‹œ
                if (serials.length > 1) {
                    showLoading(false);
                    showMultiSerialModal(serials);
                } else {
                    await processSerial(serials[0]);
                    updateUI();
                    showToast('ì‹œë¦¬ì–¼ ì¸ì‹ ì™„ë£Œ');
                    showLoading(false);
                }

            } catch (err) {
                console.error(err);
                showToast('ì˜¤ë¥˜: ' + err.message);
                showLoading(false);
            }

            e.target.value = '';
        }

        // ===== Multi Serial Select =====
        function showMultiSerialModal(serials) {
            var modal = document.getElementById('multiSerialModal');
            var content = document.getElementById('multiSerialContent');

            var html = '<div class="modal-header">' +
                '<span class="modal-title">ì¸ì‹ëœ ì‹œë¦¬ì–¼ (' + serials.length + 'ê°œ)</span>' +
                '<button class="modal-close" onclick="closeMultiSerialModal()">Ã—</button>' +
            '</div>';

            html += '<p style="font-size:13px;color:var(--sju-gray-600);margin-bottom:12px;">ì¶”ê°€í•  ì‹œë¦¬ì–¼ì„ ì„ íƒí•˜ì„¸ìš”</p>';

            html += '<div id="serialSelectList">';
            serials.forEach(function(sn, idx) {
                html += '<div class="serial-select-item selected" onclick="toggleSerialSelect(' + idx + ')">' +
                    '<input type="checkbox" checked data-serial="' + sn + '">' +
                    '<div class="serial-select-info">' +
                        '<div class="serial-select-sn">' + sn + '</div>' +
                        '<div class="serial-select-status">ì¡°íšŒ ì¤‘...</div>' +
                    '</div>' +
                '</div>';
            });
            html += '</div>';

            html += '<div class="case-actions" style="margin-top:16px;">' +
                '<button class="case-btn primary" onclick="processSelectedSerials()">ì„ íƒ í•­ëª© ì¶”ê°€</button>' +
                '<button class="case-btn secondary" onclick="closeMultiSerialModal()">ì·¨ì†Œ</button>' +
            '</div>';

            content.innerHTML = html;
            modal.classList.add('active');

            // ê° ì‹œë¦¬ì–¼ ìƒíƒœ ì¡°íšŒ
            serials.forEach(function(sn, idx) {
                lookupSerial(sn, currentDeptCode).then(function(result) {
                    var statusText = getStatusText(result.case, result.data);
                    var statusEl = document.querySelectorAll('.serial-select-status')[idx];
                    if (statusEl) statusEl.textContent = statusText;
                });
            });
        }

        function toggleSerialSelect(idx) {
            var items = document.querySelectorAll('.serial-select-item');
            var item = items[idx];
            var checkbox = item.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            item.classList.toggle('selected', checkbox.checked);
        }

        async function processSelectedSerials() {
            var checkboxes = document.querySelectorAll('#serialSelectList input[type="checkbox"]:checked');
            var count = 0;

            for (var i = 0; i < checkboxes.length; i++) {
                var serial = checkboxes[i].getAttribute('data-serial');
                await processSerial(serial);
                count++;
            }

            closeMultiSerialModal();
            updateUI();
            showToast(count + 'ê°œ ì‹œë¦¬ì–¼ ì¶”ê°€ë¨');
        }

        function closeMultiSerialModal() {
            document.getElementById('multiSerialModal').classList.remove('active');
        }

        function getStatusText(caseType, data) {
            switch (caseType) {
                case 'A1-1': return 'ì •ìƒ (ê°™ì€ ë¶€ì„œ)';
                case 'A1-2': return 'ìˆ˜ë¦¬ì¤‘ (ê°™ì€ ë¶€ì„œ)';
                case 'A1-3': return 'íê¸°ë¨';
                case 'A1-4': return 'ë¶„ì‹¤ ìƒíƒœ';
                case 'A2-1': return 'ì´ë™ í•„ìš” (' + (data ? data.dept : '') + ')';
                case 'A2-2': return 'ì´ë™+ìˆ˜ë¦¬ì¤‘';
                case 'B1': return 'ë‚©í’ˆ ëŒ€ê¸°';
                case 'C1': return 'ë¯¸ë“±ë¡ ìì‚°';
                default: return 'í™•ì¸ í•„ìš”';
            }
        }

        // ===== Process Serial =====
        async function processSerial(serial) {
            if (scannedItems.some(function(item) { return item.serial === serial; })) {
                showToast(serial.substring(0, 10) + '... ì´ë¯¸ ìŠ¤ìº”ë¨');
                return;
            }

            var result = await lookupSerial(serial, currentDeptCode);

            var item = {
                serial: serial,
                case: result.case,
                data: result.data,
                source: result.source,
                status: 'pending',
                timestamp: new Date()
            };

            // A1-1ë§Œ ìë™ ì™„ë£Œ ì²˜ë¦¬
            if (result.case === 'A1-1') {
                item.status = 'ok';
            }

            scannedItems.push(item);

            // ëª¨ë“  ì¼€ì´ìŠ¤ì—ì„œ íŒì—… í‘œì‹œ (A1-1 ì œì™¸)
            if (result.case !== 'A1-1') {
                showCasePopup(item);
            }
        }

        // ===== Case Popup =====
        function showCasePopup(item) {
            var modal = document.getElementById('caseModal');
            var content = document.getElementById('caseModalContent');
            var currentDept = MOCK_DEPARTMENTS[currentDeptCode];

            var html = '<div class="modal-header">' +
                '<span class="modal-title">' + getCaseTitle(item.case) + '</span>' +
                '<button class="modal-close" onclick="closeCaseModal()">Ã—</button>' +
            '</div>';

            html += '<div class="case-info">' +
                '<div class="case-serial">' + item.serial + '</div>';

            if (item.data) {
                html += '<div class="case-detail">' +
                    item.data.model + ' | ' + item.data.assetType + '<br>' +
                    'ë“±ë¡ ë¶€ì„œ: ' + item.data.dept;
                if (item.data.user) html += ' | ' + item.data.user;
                html += '</div>';
                html += '<span class="case-status-badge ' + getStatusBadgeClass(item.case) + '">' + getStatusBadgeText(item.case) + '</span>';
            } else {
                html += '<div class="case-detail">ë“±ë¡ë˜ì§€ ì•Šì€ ìì‚°ì…ë‹ˆë‹¤</div>';
            }
            html += '</div>';

            html += '<div class="case-actions">';

            switch (item.case) {
                case 'A1-1': // ì •ìƒ
                    html += '<p style="font-size:14px;color:var(--sju-success);margin-bottom:10px;">âœ“ ì •ìƒ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤</p>';
                    html += '<button class="case-btn primary" onclick="closeCaseModal()">í™•ì¸</button>';
                    break;

                case 'A1-2': // ìˆ˜ë¦¬ì¤‘ (ê°™ì€ ë¶€ì„œ)
                    html += '<button class="case-btn success" onclick="handleCase(\'' + item.serial + '\', \'repair-complete\')">ìˆ˜ë¦¬ì™„ë£Œ ì²˜ë¦¬</button>';
                    html += '<button class="case-btn secondary" onclick="handleCase(\'' + item.serial + '\', \'keep-repair\')">ìˆ˜ë¦¬ì¤‘ ìœ ì§€ (ì ê²€ì™„ë£Œ)</button>';
                    break;

                case 'A1-3': // íê¸°
                    html += '<p style="font-size:13px;color:var(--sju-danger);margin-bottom:10px;">âš ï¸ íê¸°ëœ ìì‚°ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤</p>';
                    html += '<button class="case-btn warning" onclick="handleCase(\'' + item.serial + '\', \'cancel-dispose\')">íê¸° ì·¨ì†Œ (ë³µêµ¬)</button>';
                    html += '<button class="case-btn secondary" onclick="handleCase(\'' + item.serial + '\', \'confirm-dispose\')">íê¸° í™•ì¸ (ê²½ê³  ê¸°ë¡)</button>';
                    break;

                case 'A1-4': // ë¶„ì‹¤
                    html += '<p style="font-size:13px;color:var(--sju-warning);margin-bottom:10px;">ğŸ” ë¶„ì‹¤ ì‹ ê³ ëœ ìì‚°ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!</p>';
                    html += '<button class="case-btn success" onclick="handleCase(\'' + item.serial + '\', \'recover\')">ë¶„ì‹¤ ë³µêµ¬</button>';
                    html += '<button class="case-btn secondary" onclick="handleCase(\'' + item.serial + '\', \'keep-lost\')">ë¶„ì‹¤ ìœ ì§€</button>';
                    break;

                case 'A2-1': // ì´ë™
                    html += '<p style="font-size:13px;color:var(--sju-gray-600);margin-bottom:10px;">' +
                        item.data.dept + ' â†’ ' + currentDept.name + ' ì´ë™</p>';
                    html += '<button class="case-btn primary" onclick="handleCase(\'' + item.serial + '\', \'move\')">' + currentDept.name + 'ìœ¼ë¡œ ì´ë™</button>';
                    html += '<button class="case-btn secondary" onclick="handleCase(\'' + item.serial + '\', \'keep-dept\')">' + item.data.dept + ' ìœ ì§€</button>';
                    break;

                case 'A2-2': // ì´ë™ + ìˆ˜ë¦¬ì¤‘
                    html += '<p style="font-size:13px;color:var(--sju-gray-600);margin-bottom:10px;">' +
                        'ë¶€ì„œ: ' + item.data.dept + ' â†’ ' + currentDept.name + '<br>ìƒíƒœ: ìˆ˜ë¦¬ì¤‘</p>';
                    html += '<button class="case-btn success" onclick="handleCase(\'' + item.serial + '\', \'move-repair\')">ì´ë™ + ìˆ˜ë¦¬ì™„ë£Œ</button>';
                    html += '<button class="case-btn primary" onclick="handleCase(\'' + item.serial + '\', \'move-only\')">ì´ë™ë§Œ (ìˆ˜ë¦¬ì¤‘ ìœ ì§€)</button>';
                    html += '<button class="case-btn secondary" onclick="handleCase(\'' + item.serial + '\', \'keep-all\')">í˜„ì¬ ìƒíƒœ ìœ ì§€</button>';
                    break;

                case 'B1': // ë‚©í’ˆ ë§¤ì¹­
                    html += '<p style="font-size:13px;color:#2563eb;margin-bottom:10px;">ğŸ“¦ ë‚©í’ˆ ì˜ˆì • ëª©ë¡ê³¼ ì¼ì¹˜í•©ë‹ˆë‹¤</p>';
                    if (item.data) {
                        html += '<p style="font-size:12px;color:var(--sju-gray-600);margin-bottom:10px;">' +
                            'ëª¨ë¸: ' + item.data.model + '<br>ë‚©í’ˆì˜ˆì •: ' + item.data.expectedDate + '</p>';
                    }
                    html += '<button class="case-btn success" onclick="handleCase(\'' + item.serial + '\', \'receive\')">ì…ê³  í™•ì¸</button>';
                    html += '<button class="case-btn secondary" onclick="handleCase(\'' + item.serial + '\', \'skip-delivery\')">ë‚˜ì¤‘ì— ì²˜ë¦¬</button>';
                    break;

                case 'C1': // ë¯¸ë“±ë¡
                    html += '<p style="font-size:13px;color:var(--sju-gray-600);margin-bottom:10px;">ë“±ë¡ë˜ì§€ ì•Šì€ ìì‚°ì…ë‹ˆë‹¤. ë“±ë¡ ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”.</p>';
                    html += '<button class="case-btn accent" onclick="showQuickRegister(\'' + item.serial + '\')">ê°„í¸ ë“±ë¡</button>';
                    html += '<button class="case-btn primary" onclick="handleCase(\'' + item.serial + '\', \'register-later\')">ë‚˜ì¤‘ì— ë“±ë¡ (PCì—ì„œ)</button>';
                    html += '<button class="case-btn secondary" onclick="handleCase(\'' + item.serial + '\', \'skip-unregistered\')">ê±´ë„ˆë›°ê¸°</button>';
                    break;

                default:
                    html += '<button class="case-btn primary" onclick="closeCaseModal()">í™•ì¸</button>';
            }

            html += '</div>';

            content.innerHTML = html;
            modal.classList.add('active');
        }

        function getCaseTitle(caseType) {
            switch (caseType) {
                case 'A1-1': return 'ì •ìƒ';
                case 'A1-2': return 'ìˆ˜ë¦¬ì¤‘ ìì‚°';
                case 'A1-3': return 'íê¸° ìì‚° ë°œê²¬';
                case 'A1-4': return 'ë¶„ì‹¤ ìì‚° ë°œê²¬';
                case 'A2-1': return 'ë¶€ì„œ ì´ë™';
                case 'A2-2': return 'ë¶€ì„œ ì´ë™ + ìˆ˜ë¦¬ì¤‘';
                case 'B1': return 'ë‚©í’ˆ ë§¤ì¹­';
                case 'C1': return 'ë¯¸ë“±ë¡ ìì‚°';
                default: return 'í™•ì¸ í•„ìš”';
            }
        }

        function getStatusBadgeClass(caseType) {
            switch (caseType) {
                case 'A1-1': return 'badge-ok';
                case 'A1-2': return 'badge-repair';
                case 'A1-3': return 'badge-dispose';
                case 'A1-4': return 'badge-lost';
                case 'A2-1': case 'A2-2': return 'badge-move';
                case 'B1': return 'badge-delivery';
                default: return 'badge-unregistered';
            }
        }

        function getStatusBadgeText(caseType) {
            switch (caseType) {
                case 'A1-1': return 'ì •ìƒ';
                case 'A1-2': return 'ìˆ˜ë¦¬ì¤‘';
                case 'A1-3': return 'íê¸°';
                case 'A1-4': return 'ë¶„ì‹¤';
                case 'A2-1': return 'ì´ë™ í•„ìš”';
                case 'A2-2': return 'ì´ë™+ìˆ˜ë¦¬';
                case 'B1': return 'ë‚©í’ˆ ëŒ€ê¸°';
                default: return 'ë¯¸ë“±ë¡';
            }
        }

        function closeCaseModal() {
            document.getElementById('caseModal').classList.remove('active');
            updateUI();
        }

        // ===== Quick Register (ê°„í¸ë“±ë¡) =====
        function showQuickRegister(serial) {
            var content = document.getElementById('caseModalContent');
            var currentDept = MOCK_DEPARTMENTS[currentDeptCode];

            var html = '<div class="modal-header">' +
                '<span class="modal-title">ê°„í¸ ë“±ë¡</span>' +
                '<button class="modal-close" onclick="closeCaseModal()">Ã—</button>' +
            '</div>';

            html += '<div class="case-info">' +
                '<div class="case-serial">' + serial + '</div>' +
                '<div class="case-detail">ë“±ë¡ ìœ„ì¹˜: ' + currentDept.name + '</div>' +
            '</div>';

            html += '<div class="form-group">' +
                '<label class="form-label">ì¥ë¹„ ìœ í˜• *</label>' +
                '<select class="form-select" id="regAssetType">' +
                '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            ASSET_TYPES.forEach(function(t) { html += '<option value="' + t + '">' + t + '</option>'; });
            html += '</select></div>';

            html += '<div class="form-group">' +
                '<label class="form-label">ì œì¡°ì‚¬ *</label>' +
                '<select class="form-select" id="regManufacturer">' +
                '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            MANUFACTURERS.forEach(function(m) { html += '<option value="' + m + '">' + m + '</option>'; });
            html += '</select></div>';

            html += '<div class="form-group">' +
                '<label class="form-label">ëª¨ë¸ëª…</label>' +
                '<input type="text" class="form-input" id="regModel" placeholder="ì˜ˆ: LG ê·¸ë¨ 15">' +
            '</div>';

            html += '<div class="case-actions">' +
                '<button class="case-btn accent" onclick="submitQuickRegister(\'' + serial + '\')">ë“±ë¡</button>' +
                '<button class="case-btn secondary" onclick="showCasePopup(scannedItems.find(function(i){return i.serial===\'' + serial + '\'}))">ë’¤ë¡œ</button>' +
            '</div>';

            content.innerHTML = html;
        }

        function submitQuickRegister(serial) {
            var assetType = document.getElementById('regAssetType').value;
            var manufacturer = document.getElementById('regManufacturer').value;
            var model = document.getElementById('regModel').value;

            if (!assetType || !manufacturer) {
                showToast('ì¥ë¹„ ìœ í˜•ê³¼ ì œì¡°ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”');
                return;
            }

            // ì„ì‹œ ì €ì¥
            tempRegistrations[serial] = {
                serial: serial,
                assetType: assetType,
                manufacturer: manufacturer,
                model: model || (manufacturer + ' ' + assetType),
                dept: MOCK_DEPARTMENTS[currentDeptCode].name,
                deptCode: currentDeptCode,
                registeredAt: new Date()
            };

            // ìƒíƒœ ì—…ë°ì´íŠ¸
            var item = scannedItems.find(function(i) { return i.serial === serial; });
            if (item) {
                item.status = 'new';
                item.action = 'quick-register';
                item.registrationData = tempRegistrations[serial];
            }

            closeCaseModal();
            showToast('ê°„í¸ ë“±ë¡ ì™„ë£Œ');
        }

        // ===== Handle Case Actions =====
        function handleCase(serial, action) {
            var item = scannedItems.find(function(i) { return i.serial === serial; });
            if (!item) return;

            switch (action) {
                // ì •ìƒ ì²˜ë¦¬
                case 'repair-complete':
                case 'recover':
                case 'cancel-dispose':
                    item.status = 'ok';
                    item.action = action;
                    break;

                // ì´ë™ ì²˜ë¦¬
                case 'move':
                case 'move-repair':
                case 'move-only':
                    item.status = 'move';
                    item.action = action;
                    item.targetDept = currentDeptCode;
                    break;

                // ì…ê³  í™•ì¸
                case 'receive':
                    item.status = 'new';
                    item.action = 'receive';
                    break;

                // ë‚˜ì¤‘ì— ë“±ë¡ (PCì—ì„œ)
                case 'register-later':
                    item.status = 'new';
                    item.action = 'register-later';
                    break;

                // ìƒíƒœ ìœ ì§€í•˜ë©° ì ê²€ ì™„ë£Œ ì²˜ë¦¬
                case 'keep-repair':
                case 'keep-lost':
                case 'keep-dept':
                case 'keep-all':
                case 'confirm-dispose':
                    item.status = 'warning';  // ê²½ê³  ìƒíƒœë¡œ í‘œì‹œí•˜ë˜ ì ê²€ì€ ì™„ë£Œ
                    item.action = action;
                    break;

                // ê±´ë„ˆë›°ê¸° (ì´ë²ˆ ì ê²€ì—ì„œ ì œì™¸)
                case 'skip-delivery':
                case 'skip-unregistered':
                    // ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°
                    var idx = scannedItems.indexOf(item);
                    if (idx > -1) scannedItems.splice(idx, 1);
                    closeCaseModal();
                    updateUI();
                    showToast('ê±´ë„ˆë›°ê¸° ì²˜ë¦¬ë¨');
                    return;
            }

            closeCaseModal();
            showToast('ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤');
        }

        // ===== UI Update =====
        function updateUI() {
            var count = scannedItems.length;
            var pendingCount = scannedItems.filter(function(i) { return i.status === 'pending'; }).length;

            document.getElementById('headerCount').textContent = count + 'ê±´';
            document.getElementById('resultsCount').textContent = count + 'ê±´';
            document.getElementById('btnComplete').disabled = count === 0;

            if (pendingCount > 0) {
                document.getElementById('btnComplete').textContent = 'ì ê²€ ì™„ë£Œ (' + count + 'ê±´, ë¯¸ì²˜ë¦¬ ' + pendingCount + 'ê±´)';
            } else {
                document.getElementById('btnComplete').textContent = 'ì ê²€ ì™„ë£Œ (' + count + 'ê±´)';
            }

            var listEl = document.getElementById('resultsList');

            if (count === 0) {
                listEl.innerHTML = '<div class="empty-state">' +
                    '<div class="empty-icon">ğŸ“‹</div>' +
                    '<div class="empty-text">ìŠ¤ìº”ëœ ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤</div>' +
                '</div>';
                return;
            }

            listEl.innerHTML = scannedItems.map(function(item) {
                var statusIcon = getStatusIcon(item.status);
                var statusClass = item.status;
                var badge = getBadge(item);
                var detail = getDetail(item);

                return '<div class="result-item" onclick="showItemDetail(\'' + item.serial + '\')">' +
                    '<div class="result-status ' + statusClass + '">' + statusIcon + '</div>' +
                    '<div class="result-info">' +
                        '<div class="result-serial">' + item.serial + '</div>' +
                        '<div class="result-detail">' + detail + '</div>' +
                    '</div>' +
                    '<span class="result-badge ' + badge.class + '">' + badge.text + '</span>' +
                '</div>';
            }).join('');
        }

        function getStatusIcon(status) {
            switch (status) {
                case 'ok': return 'âœ“';
                case 'move': return 'â†’';
                case 'warning': return '!';
                case 'error': return 'âœ•';
                case 'new': return '+';
                default: return '?';
            }
        }

        function getBadge(item) {
            // ì²˜ë¦¬ ì™„ë£Œëœ ìƒíƒœ í‘œì‹œ
            if (item.action === 'quick-register' || item.action === 'register-later') {
                return { class: 'badge-registered', text: 'ë“±ë¡' };
            }
            if (item.action === 'receive') {
                return { class: 'badge-delivery', text: 'ì…ê³ ' };
            }

            switch (item.case) {
                case 'A1-1': return { class: 'badge-ok', text: 'ì •ìƒ' };
                case 'A1-2': return { class: 'badge-repair', text: item.action === 'repair-complete' ? 'ìˆ˜ë¦¬ì™„ë£Œ' : 'ìˆ˜ë¦¬ì¤‘' };
                case 'A1-3': return { class: 'badge-dispose', text: 'íê¸°' };
                case 'A1-4': return { class: 'badge-lost', text: item.action === 'recover' ? 'ë³µêµ¬' : 'ë¶„ì‹¤' };
                case 'A2-1': return { class: 'badge-move', text: 'ì´ë™' };
                case 'A2-2': return { class: 'badge-move', text: 'ì´ë™' };
                case 'B1': return { class: 'badge-delivery', text: 'ë‚©í’ˆ' };
                case 'C1': return { class: 'badge-unregistered', text: 'ë¯¸ë“±ë¡' };
                default: return { class: 'badge-unregistered', text: 'í™•ì¸í•„ìš”' };
            }
        }

        function getDetail(item) {
            if (item.registrationData) {
                return item.registrationData.model + ' | ' + item.registrationData.dept;
            }
            if (item.data) {
                return item.data.model + ' | ' + (item.data.dept || 'ë¯¸ì •');
            }
            return 'ë¯¸ë“±ë¡ ìì‚°';
        }

        function showItemDetail(serial) {
            var item = scannedItems.find(function(i) { return i.serial === serial; });
            if (item) showCasePopup(item);
        }

        // ===== Complete Check =====
        function completeCheck() {
            var pendingCount = scannedItems.filter(function(i) { return i.status === 'pending'; }).length;
            if (pendingCount > 0) {
                showToast(pendingCount + 'ê±´ì˜ ë¯¸ì²˜ë¦¬ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤');
                return;
            }

            // ê²°ê³¼ ìš”ì•½
            var okCount = scannedItems.filter(function(i) { return i.status === 'ok'; }).length;
            var moveCount = scannedItems.filter(function(i) { return i.status === 'move'; }).length;
            var newCount = scannedItems.filter(function(i) { return i.status === 'new'; }).length;
            var warnCount = scannedItems.filter(function(i) { return i.status === 'warning'; }).length;

            var summary = 'ì ê²€ ì™„ë£Œ!\n';
            summary += 'ì •ìƒ: ' + okCount + 'ê±´';
            if (moveCount > 0) summary += ', ì´ë™: ' + moveCount + 'ê±´';
            if (newCount > 0) summary += ', ë“±ë¡: ' + newCount + 'ê±´';
            if (warnCount > 0) summary += ', ê²½ê³ : ' + warnCount + 'ê±´';

            showToast(summary);

            // 3ì´ˆ í›„ ë¦¬ì…‹
            setTimeout(function() {
                scannedItems = [];
                tempRegistrations = {};
                updateUI();
            }, 3000);
        }

        // ===== Utility Functions =====
        function showToast(message) {
            var toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(function() { toast.classList.remove('show'); }, 2500);
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('active', show);
        }

        // ===== Image Processing =====
        function resizeImage(file, maxWidth) {
            return new Promise(function(resolve) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var img = new Image();
                    img.onload = function() {
                        var canvas = document.createElement('canvas');
                        var width = img.width, height = img.height;
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                        var dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                        resolve({ dataUrl: dataUrl, base64: dataUrl.split(',')[1], width: width, height: height });
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // ===== Google Vision API =====
        async function callVisionAPI(base64, apiKey) {
            var response = await fetch('https://vision.googleapis.com/v1/images:annotate?key=' + apiKey, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    requests: [{ image: { content: base64 }, features: [{ type: 'TEXT_DETECTION' }] }]
                })
            });
            var data = await response.json();
            if (data.error) throw new Error(data.error.message);
            var textAnnotations = data.responses[0] && data.responses[0].textAnnotations;
            return textAnnotations && textAnnotations.length > 0 ? textAnnotations[0].description : null;
        }

        // ===== Serial Extraction =====
        function extractSerials(text) {
            if (!text) return [];
            var excludeWords = /^(number|serial|model|part|product|type|version|no|sn|id|null|test|match|barcode|qr|code)$/i;
            var candidates = [];
            var patterns = [
                /\b(\d{2,3}LG[A-Z]\d[A-Z][A-Z0-9]{10,})\b/gi,
                /\b(G[12]L\d{3}E\d{5}-\d{5})\b/gi,
                /\b(TAG-?N\d+[A-Z]+\d+-[A-Z]?\d+)\b/gi,
                /\b(CW[A-Z0-9]{2,4}H[0-9][A-Z]{2}[A-Z0-9]{6,})\b/gi,
                /\b(LED\d{10}[A-Z]\d)\b/gi,
                /\b([A-Z]{2,4}\d{2,4}[A-Z0-9]{6,})\b/gi,
                /\b(\d{3}[A-Z]{2,4}[A-Z0-9]{6,})\b/gi
            ];
            patterns.forEach(function(pattern) {
                var matches = text.match(pattern);
                if (matches) {
                    matches.forEach(function(m) {
                        if (!excludeWords.test(m) && m.length >= 10) candidates.push(m);
                    });
                }
            });
            var unique = [], seen = {};
            candidates.forEach(function(c) {
                if (!seen[c]) { seen[c] = true; unique.push(c); }
            });
            return unique.slice(0, 5);
        }
    </script>
</body>
</html>
