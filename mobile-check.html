<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìì‚° ì ê²€</title>
    <style>
        /* ===== SJU Design System Variables ===== */
        :root {
            --sju-primary: #11306E;
            --sju-primary-hover: #0a1f4a;
            --sju-accent: #E6007E;
            --sju-success: #00978E;
            --sju-success-bg: #e0f2f1;
            --sju-warning: #f59e0b;
            --sju-warning-bg: #fef3c7;
            --sju-danger: #ef4444;
            --sju-danger-bg: #fee2e2;
            --sju-gray-100: #f5f5f5;
            --sju-gray-200: #eeeeee;
            --sju-gray-300: #e0e0e0;
            --sju-gray-500: #9e9e9e;
            --sju-gray-600: #757575;
            --sju-gray-700: #616161;
            --sju-gray-800: #424242;
            --sju-white: #ffffff;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Pretendard', 'Malgun Gothic', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--sju-gray-100);
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        /* ===== Header ===== */
        .header {
            background-color: var(--sju-primary);
            color: var(--sju-white);
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-title { font-size: 18px; font-weight: 600; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .header-count { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 16px; font-size: 12px; }
        .header-settings {
            width: 32px; height: 32px; border-radius: 50%;
            background: rgba(255,255,255,0.2); border: none;
            color: var(--sju-white); font-size: 18px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* ===== Scan Area (ìƒë‹¨) ===== */
        .scan-area {
            background: linear-gradient(135deg, var(--sju-primary) 0%, #1a4a9e 100%);
            margin: 12px;
            padding: 24px 16px;
            border-radius: var(--radius-lg);
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: var(--shadow-md);
        }
        .scan-area:active { transform: scale(0.98); }
        .scan-icon { font-size: 40px; margin-bottom: 8px; }
        .scan-text { color: var(--sju-white); font-size: 16px; font-weight: 500; }
        .scan-hint { color: rgba(255,255,255,0.7); font-size: 12px; margin-top: 6px; }

        /* ===== Recognition Result (ì¸ì‹ ê²°ê³¼ ì˜ì—­) ===== */
        .recognition-area {
            background: var(--sju-white);
            margin: 0 12px 12px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            display: none;
        }
        .recognition-area.active { display: block; }
        .recognition-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--sju-gray-200);
            font-size: 13px; font-weight: 600; color: var(--sju-gray-700);
        }
        .recognition-content { padding: 16px; }
        .recognition-serial {
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 18px; font-weight: 700; color: var(--sju-primary);
            text-align: center; margin-bottom: 12px;
            padding: 12px; background: var(--sju-gray-100); border-radius: var(--radius-sm);
        }
        .recognition-status {
            text-align: center; padding: 8px 12px;
            border-radius: var(--radius-sm); font-size: 13px; margin-bottom: 12px;
        }
        .recognition-status.ok { background: var(--sju-success-bg); color: var(--sju-success); }
        .recognition-status.move { background: #e0f2fe; color: #0284c7; }
        .recognition-status.warning { background: var(--sju-warning-bg); color: #d97706; }
        .recognition-status.new { background: #ede9fe; color: #7c3aed; }
        .recognition-status.unregistered { background: var(--sju-gray-200); color: var(--sju-gray-700); }

        /* ===== Action Buttons (ì•¡ì…˜ ë²„íŠ¼) ===== */
        .action-buttons {
            display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;
        }
        .action-btn {
            flex: 1; min-width: calc(33% - 6px);
            padding: 10px 8px; border: none; border-radius: var(--radius-sm);
            font-size: 13px; font-weight: 500; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
        }
        .action-btn .icon { font-size: 20px; }
        .action-btn.primary { background: var(--sju-primary); color: var(--sju-white); }
        .action-btn.success { background: var(--sju-success); color: var(--sju-white); }
        .action-btn.warning { background: var(--sju-warning); color: var(--sju-white); }
        .action-btn.accent { background: var(--sju-accent); color: var(--sju-white); }
        .action-btn.secondary { background: var(--sju-gray-200); color: var(--sju-gray-700); }
        .action-btn.selected { box-shadow: 0 0 0 3px rgba(17,48,110,0.3); }

        /* ===== Manual Input ===== */
        .manual-input-row {
            display: flex; gap: 8px;
        }
        .manual-input {
            flex: 1; padding: 10px 12px;
            border: 1px solid var(--sju-gray-300); border-radius: var(--radius-sm);
            font-size: 14px; font-family: 'Consolas', monospace;
        }
        .manual-input:focus { outline: none; border-color: var(--sju-primary); }
        .manual-btn {
            padding: 10px 16px; background: var(--sju-primary); color: var(--sju-white);
            border: none; border-radius: var(--radius-sm); font-size: 14px; cursor: pointer;
        }

        /* ===== Results Section ===== */
        .results-section { padding: 0 12px; padding-bottom: 140px; }
        .results-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 4px;
        }
        .results-title { font-size: 14px; font-weight: 600; color: var(--sju-gray-700); }
        .results-count { font-size: 12px; color: var(--sju-gray-500); }

        /* ===== Result Item ===== */
        .result-item {
            background: var(--sju-white);
            border-radius: var(--radius-md);
            padding: 12px 14px;
            margin-bottom: 8px;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        .result-item:active { background: var(--sju-gray-100); }
        .result-status {
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; flex-shrink: 0;
        }
        .result-status.ok { background: var(--sju-success-bg); }
        .result-status.move { background: #e0f2fe; }
        .result-status.warning { background: var(--sju-warning-bg); }
        .result-status.pending { background: var(--sju-gray-200); }
        .result-status.new { background: #ede9fe; }
        .result-info { flex: 1; min-width: 0; }
        .result-serial {
            font-family: 'Consolas', monospace;
            font-size: 13px; font-weight: 600; color: var(--sju-gray-800);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .result-detail { font-size: 11px; color: var(--sju-gray-600); margin-top: 2px; }
        .result-badge {
            font-size: 10px; padding: 3px 8px; border-radius: 10px;
            font-weight: 500; white-space: nowrap;
        }
        .badge-ok { background: var(--sju-success-bg); color: var(--sju-success); }
        .badge-move { background: #e0f2fe; color: #0284c7; }
        .badge-repair { background: var(--sju-warning-bg); color: #d97706; }
        .badge-dispose { background: var(--sju-danger-bg); color: var(--sju-danger); }
        .badge-lost { background: #ffedd5; color: #ea580c; }
        .badge-delivery { background: #dbeafe; color: #2563eb; }
        .badge-unregistered { background: var(--sju-gray-200); color: var(--sju-gray-700); }
        .badge-registered { background: #ede9fe; color: #7c3aed; }

        /* ===== Empty State ===== */
        .empty-state { text-align: center; padding: 30px 20px; color: var(--sju-gray-500); }
        .empty-icon { font-size: 40px; margin-bottom: 10px; opacity: 0.5; }
        .empty-text { font-size: 13px; }

        /* ===== Bottom Section (ë¶€ì„œ + ì™„ë£Œë²„íŠ¼) ===== */
        .bottom-section {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--sju-white);
            border-top: 1px solid var(--sju-gray-200);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .location-bar {
            padding: 10px 16px;
            display: flex; align-items: center; gap: 10px;
            border-bottom: 1px solid var(--sju-gray-200);
            cursor: pointer;
        }
        .location-bar:active { background: var(--sju-gray-100); }
        .location-icon { font-size: 16px; }
        .location-text { flex: 1; }
        .location-label { font-size: 10px; color: var(--sju-gray-500); }
        .location-value { font-size: 13px; font-weight: 500; color: var(--sju-gray-800); }
        .location-arrow { color: var(--sju-gray-500); font-size: 12px; }

        .bottom-buttons { padding: 12px 16px; }
        .btn-complete {
            width: 100%; padding: 14px;
            background: var(--sju-primary); color: var(--sju-white);
            border: none; border-radius: var(--radius-md);
            font-size: 15px; font-weight: 600; cursor: pointer;
        }
        .btn-complete:active { background: var(--sju-primary-hover); }
        .btn-complete:disabled { background: #bdbdbd; cursor: not-allowed; }

        /* ===== Modals ===== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: flex-end;
            z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: var(--sju-white); width: 100%; max-height: 80vh;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            padding: 20px; padding-bottom: max(20px, env(safe-area-inset-bottom));
            animation: slideUp 0.3s ease-out; overflow-y: auto;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px;
        }
        .modal-title { font-size: 17px; font-weight: 600; color: var(--sju-gray-800); }
        .modal-close {
            width: 30px; height: 30px; border: none;
            background: var(--sju-gray-100); border-radius: 50%;
            font-size: 18px; color: var(--sju-gray-600); cursor: pointer;
        }

        /* ===== Settings Modal ===== */
        .settings-item { margin-bottom: 16px; }
        .settings-label { font-size: 12px; color: var(--sju-gray-600); margin-bottom: 6px; }
        .settings-input {
            width: 100%; padding: 12px;
            border: 1px solid var(--sju-gray-300); border-radius: var(--radius-sm);
            font-size: 14px;
        }
        .settings-input:focus { outline: none; border-color: var(--sju-primary); }

        /* ===== Department List ===== */
        .dept-list { max-height: 280px; overflow-y: auto; }
        .dept-item {
            padding: 12px 14px; border-bottom: 1px solid var(--sju-gray-200);
            cursor: pointer;
        }
        .dept-item:active { background: var(--sju-gray-100); }
        .dept-item.selected { background: #e8f5e9; }
        .dept-name { font-size: 14px; color: var(--sju-gray-800); }
        .dept-location { font-size: 11px; color: var(--sju-gray-500); }

        /* ===== Form Styles ===== */
        .form-group { margin-bottom: 12px; }
        .form-label { font-size: 12px; color: var(--sju-gray-700); margin-bottom: 4px; font-weight: 500; }
        .form-select {
            width: 100%; padding: 10px; border: 1px solid var(--sju-gray-300);
            border-radius: var(--radius-sm); font-size: 14px;
        }
        .form-input {
            width: 100%; padding: 10px; border: 1px solid var(--sju-gray-300);
            border-radius: var(--radius-sm); font-size: 14px;
        }

        /* ===== Case Actions ===== */
        .case-info {
            background: var(--sju-gray-100); padding: 14px;
            border-radius: var(--radius-md); margin-bottom: 14px;
        }
        .case-serial {
            font-family: 'Consolas', monospace;
            font-size: 15px; font-weight: 600; color: var(--sju-primary); margin-bottom: 6px;
        }
        .case-detail { font-size: 12px; color: var(--sju-gray-700); line-height: 1.4; }
        .case-actions { display: flex; flex-direction: column; gap: 8px; }
        .case-btn {
            padding: 12px 14px; border: none; border-radius: var(--radius-md);
            font-size: 14px; font-weight: 500; cursor: pointer; text-align: center;
        }
        .case-btn.primary { background: var(--sju-primary); color: var(--sju-white); }
        .case-btn.secondary { background: var(--sju-gray-200); color: var(--sju-gray-700); }
        .case-btn.success { background: var(--sju-success); color: var(--sju-white); }
        .case-btn.warning { background: var(--sju-warning); color: var(--sju-white); }
        .case-btn.accent { background: var(--sju-accent); color: var(--sju-white); }

        /* ===== Toast ===== */
        .toast {
            position: fixed; bottom: 160px; left: 50%;
            transform: translateX(-50%) translateY(50px);
            background: rgba(0,0,0,0.85); color: var(--sju-white);
            padding: 10px 20px; border-radius: 20px; font-size: 13px;
            opacity: 0; transition: all 0.3s ease; z-index: 2000; pointer-events: none;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* ===== Loading ===== */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            display: none; justify-content: center; align-items: center; flex-direction: column;
            z-index: 3000;
        }
        .loading-overlay.active { display: flex; }
        .loading-spinner {
            width: 36px; height: 36px;
            border: 3px solid var(--sju-gray-200); border-top-color: var(--sju-primary);
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 12px; font-size: 13px; color: var(--sju-gray-600); }

        .file-input-hidden { display: none; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <span class="header-title">ìì‚° ì ê²€</span>
        <div class="header-right">
            <span class="header-count" id="headerCount">0ê±´</span>
            <button class="header-settings" onclick="openSettingsModal()">âš™</button>
        </div>
    </div>

    <!-- Scan Area (ìƒë‹¨) -->
    <div class="scan-area" onclick="triggerScan()">
        <div class="scan-icon">ğŸ“·</div>
        <div class="scan-text">íƒ­í•˜ì—¬ S/N ìŠ¤ìº”</div>
        <div class="scan-hint">ë¼ë²¨ì„ ì´¬ì˜í•˜ë©´ ìë™ìœ¼ë¡œ ì¸ì‹ë©ë‹ˆë‹¤</div>
    </div>
    <input type="file" id="fileInput" class="file-input-hidden" accept="image/*" capture="environment">

    <!-- Recognition Result (ì¸ì‹ ê²°ê³¼) -->
    <div class="recognition-area" id="recognitionArea">
        <div class="recognition-header">ì¸ì‹ ê²°ê³¼</div>
        <div class="recognition-content">
            <div class="recognition-serial" id="recognizedSerial">-</div>
            <div class="recognition-status" id="recognitionStatus">-</div>

            <!-- ì•¡ì…˜ ë²„íŠ¼ -->
            <div class="action-buttons" id="actionButtons">
                <button class="action-btn success" onclick="quickAction('ok')">
                    <span class="icon">âœ“</span>
                    <span>ì ê²€ì™„ë£Œ</span>
                </button>
                <button class="action-btn warning" onclick="quickAction('repair')">
                    <span class="icon">ğŸ”§</span>
                    <span>ìˆ˜ë¦¬ì ‘ìˆ˜</span>
                </button>
                <button class="action-btn accent" onclick="quickAction('new')">
                    <span class="icon">+</span>
                    <span>ì‹ ê·œë“±ë¡</span>
                </button>
            </div>

            <!-- ìˆ˜ë™ ì…ë ¥ -->
            <div class="manual-input-row">
                <input type="text" class="manual-input" id="manualSerial" placeholder="ì‹œë¦¬ì–¼ ì§ì ‘ ì…ë ¥...">
                <button class="manual-btn" onclick="addManualSerial()">ì¶”ê°€</button>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="results-section">
        <div class="results-header">
            <span class="results-title">ìŠ¤ìº” ê¸°ë¡</span>
            <span class="results-count" id="resultsCount">0ê±´</span>
        </div>
        <div id="resultsList">
            <div class="empty-state">
                <div class="empty-icon">ğŸ“‹</div>
                <div class="empty-text">ìŠ¤ìº”ëœ ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤</div>
            </div>
        </div>
    </div>

    <!-- Bottom Section (ë¶€ì„œ + ì™„ë£Œ) -->
    <div class="bottom-section">
        <div class="location-bar" onclick="openDeptModal()">
            <span class="location-icon">ğŸ“</span>
            <div class="location-text">
                <div class="location-label">í˜„ì¬ ìœ„ì¹˜</div>
                <div class="location-value" id="currentDept">íƒ­í•˜ì—¬ ì„ íƒ</div>
            </div>
            <span class="location-arrow">â–¶</span>
        </div>
        <div class="bottom-buttons">
            <button class="btn-complete" id="btnComplete" onclick="completeCheck()">
                ì ê²€ ì™„ë£Œ
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">ì„¤ì •</span>
                <button class="modal-close" onclick="closeSettingsModal()">Ã—</button>
            </div>
            <div class="settings-item">
                <div class="settings-label">Google Vision API Key</div>
                <input type="password" class="settings-input" id="apiKey" placeholder="API Key ì…ë ¥...">
            </div>
            <button class="case-btn primary" onclick="saveSettings()">ì €ì¥</button>
        </div>
    </div>

    <!-- Department Modal -->
    <div class="modal-overlay" id="deptModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">ì ê²€ ìœ„ì¹˜ ì„ íƒ</span>
                <button class="modal-close" onclick="closeDeptModal()">Ã—</button>
            </div>
            <div class="dept-list" id="deptList"></div>
        </div>
    </div>

    <!-- Case Detail Modal -->
    <div class="modal-overlay" id="caseModal">
        <div class="modal-content" id="caseModalContent"></div>
    </div>

    <!-- Multi Serial Modal -->
    <div class="modal-overlay" id="multiSerialModal">
        <div class="modal-content" id="multiSerialContent"></div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Loading -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">ì¸ì‹ ì¤‘...</div>
    </div>

    <!-- Scripts -->
    <script src="js/mock-data.js"></script>
    <script>
        // ===== State =====
        var currentDeptCode = null;
        var scannedItems = [];
        var tempRegistrations = {};
        var lastRecognizedSerial = null;
        var lastRecognizedResult = null;

        var ASSET_TYPES = ['PC', 'ë…¸íŠ¸ë¶', 'ëª¨ë‹ˆí„°', 'í”„ë¦°í„°', 'íƒœë¸”ë¦¿', 'ê¸°íƒ€'];
        var MANUFACTURERS = ['LG', 'Samsung', 'Dell', 'HP', 'Lenovo', 'Apple', 'ê¸°íƒ€'];

        // ===== Initialization =====
        document.addEventListener('DOMContentLoaded', function() {
            var savedKey = localStorage.getItem('google_vision_api_key');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
            }
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            initDeptList();
        });

        // ===== Settings =====
        function openSettingsModal() {
            document.getElementById('settingsModal').classList.add('active');
        }
        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }
        function saveSettings() {
            var apiKey = document.getElementById('apiKey').value;
            localStorage.setItem('google_vision_api_key', apiKey);
            closeSettingsModal();
            showToast('ì„¤ì • ì €ì¥ë¨');
        }

        // ===== Department =====
        async function initDeptList() {
            var depts = await getDepartments();
            var listEl = document.getElementById('deptList');
            listEl.innerHTML = depts.map(function(d) {
                return '<div class="dept-item" onclick="selectDept(\'' + d.code + '\')">' +
                    '<div class="dept-name">' + d.name + '</div>' +
                    '<div class="dept-location">' + d.building + ' ' + d.floor + '</div></div>';
            }).join('');
        }

        function openDeptModal() { document.getElementById('deptModal').classList.add('active'); }
        function closeDeptModal() { document.getElementById('deptModal').classList.remove('active'); }

        async function selectDept(code) {
            currentDeptCode = code;
            var dept = MOCK_DEPARTMENTS[code];
            document.getElementById('currentDept').textContent = dept.building + ' > ' + dept.name;
            closeDeptModal();

            // ì¸ì‹ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ì¬íŒì •
            if (lastRecognizedSerial && lastRecognizedResult) {
                var result = await lookupSerial(lastRecognizedSerial, currentDeptCode);
                lastRecognizedResult = result;
                updateRecognitionStatus(lastRecognizedSerial, result);
            }

            showToast('ìœ„ì¹˜: ' + dept.name);
        }

        // ===== Scan =====
        function triggerScan() {
            var apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                showToast('ì„¤ì •ì—ì„œ API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                openSettingsModal();
                return;
            }
            document.getElementById('fileInput').click();
        }

        async function handleFileSelect(e) {
            var file = e.target.files[0];
            if (!file) return;

            showLoading(true);

            try {
                var resized = await resizeImage(file, 1280);
                var apiKey = document.getElementById('apiKey').value;
                var text = await callVisionAPI(resized.base64, apiKey);

                if (!text) {
                    showToast('í…ìŠ¤íŠ¸ë¥¼ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
                    showLoading(false);
                    return;
                }

                var serials = extractSerials(text);
                if (serials.length === 0) {
                    showToast('ì‹œë¦¬ì–¼ ë²ˆí˜¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
                    showLoading(false);
                    return;
                }

                showLoading(false);

                if (serials.length > 1) {
                    showMultiSerialModal(serials);
                } else {
                    await showRecognitionResult(serials[0]);
                }

            } catch (err) {
                console.error(err);
                showToast('ì˜¤ë¥˜: ' + err.message);
                showLoading(false);
            }

            e.target.value = '';
        }

        // ===== Recognition Result =====
        async function showRecognitionResult(serial) {
            lastRecognizedSerial = serial;
            var result = await lookupSerial(serial, currentDeptCode);
            lastRecognizedResult = result;

            document.getElementById('recognizedSerial').textContent = serial;
            updateRecognitionStatus(serial, result);
            document.getElementById('recognitionArea').classList.add('active');
        }

        function updateRecognitionStatus(serial, result) {
            var statusEl = document.getElementById('recognitionStatus');
            var buttonsEl = document.getElementById('actionButtons');

            var statusText = '';
            var statusClass = '';
            var buttons = '';

            if (!currentDeptCode && result.source === 'asset') {
                statusText = 'âœ“ ë“±ë¡ëœ ìì‚° (ìœ„ì¹˜ ì„ íƒ í•„ìš”)';
                statusClass = 'move';
            } else {
                switch (result.case) {
                    case 'A1-1':
                        statusText = 'âœ“ ì •ìƒ (' + result.data.dept + ')';
                        statusClass = 'ok';
                        break;
                    case 'A1-2':
                        statusText = 'ğŸ”§ ìˆ˜ë¦¬ì¤‘ (' + result.data.dept + ')';
                        statusClass = 'warning';
                        break;
                    case 'A1-3':
                        statusText = 'âš ï¸ íê¸°ëœ ìì‚°';
                        statusClass = 'warning';
                        break;
                    case 'A1-4':
                        statusText = 'ğŸ” ë¶„ì‹¤ ì‹ ê³ ëœ ìì‚°';
                        statusClass = 'warning';
                        break;
                    case 'A2-1':
                        statusText = 'â†’ ì´ë™ í•„ìš” (' + result.data.dept + ' â†’ ' + MOCK_DEPARTMENTS[currentDeptCode].name + ')';
                        statusClass = 'move';
                        break;
                    case 'A2-2':
                        statusText = 'â†’ ì´ë™+ìˆ˜ë¦¬ì¤‘ (' + result.data.dept + ')';
                        statusClass = 'move';
                        break;
                    case 'B1':
                        statusText = 'ğŸ“¦ ë‚©í’ˆ ë§¤ì¹­ (' + result.data.model + ')';
                        statusClass = 'new';
                        break;
                    case 'C1':
                        statusText = 'â“ ë¯¸ë“±ë¡ ìì‚°';
                        statusClass = 'unregistered';
                        break;
                    default:
                        statusText = 'í™•ì¸ í•„ìš”';
                        statusClass = 'unregistered';
                }
            }

            statusEl.textContent = statusText;
            statusEl.className = 'recognition-status ' + statusClass;

            // ìë™ íŒì •ì— ë”°ë¥¸ ë²„íŠ¼ í•˜ì´ë¼ì´íŠ¸
            var btns = buttonsEl.querySelectorAll('.action-btn');
            btns.forEach(function(btn) { btn.classList.remove('selected'); });

            if (result.case === 'A1-1' || result.case === 'A2-1') {
                buttonsEl.querySelector('.action-btn.success').classList.add('selected');
            } else if (result.case === 'A1-2' || result.case === 'A2-2') {
                buttonsEl.querySelector('.action-btn.warning').classList.add('selected');
            } else if (result.case === 'C1' || result.case === 'B1') {
                buttonsEl.querySelector('.action-btn.accent').classList.add('selected');
            }
        }

        // ===== Quick Actions =====
        function quickAction(action) {
            if (!lastRecognizedSerial) {
                showToast('ë¨¼ì € ìŠ¤ìº”í•˜ì„¸ìš”');
                return;
            }

            var serial = lastRecognizedSerial;
            var result = lastRecognizedResult;

            // ì¤‘ë³µ ì²´í¬
            if (scannedItems.some(function(i) { return i.serial === serial; })) {
                showToast('ì´ë¯¸ ì¶”ê°€ëœ ì‹œë¦¬ì–¼ì…ë‹ˆë‹¤');
                return;
            }

            var item = {
                serial: serial,
                case: result ? result.case : 'C1',
                data: result ? result.data : null,
                source: result ? result.source : null,
                timestamp: new Date()
            };

            switch (action) {
                case 'ok':
                    item.status = 'ok';
                    item.action = 'checked';
                    break;
                case 'repair':
                    item.status = 'warning';
                    item.action = 'repair-request';
                    break;
                case 'new':
                    if (result && result.case !== 'C1' && result.case !== 'B1') {
                        // ì´ë¯¸ ë“±ë¡ëœ ìì‚°ì¸ ê²½ìš°
                        showToast('ì´ë¯¸ ë“±ë¡ëœ ìì‚°ì…ë‹ˆë‹¤');
                        return;
                    }
                    item.status = 'new';
                    item.action = 'register';
                    break;
            }

            scannedItems.push(item);
            updateUI();
            clearRecognition();
            showToast('ì¶”ê°€ë¨: ' + action);
        }

        function clearRecognition() {
            lastRecognizedSerial = null;
            lastRecognizedResult = null;
            document.getElementById('recognitionArea').classList.remove('active');
        }

        // ===== Manual Input =====
        function addManualSerial() {
            var input = document.getElementById('manualSerial');
            var serial = input.value.trim().toUpperCase();

            if (!serial) {
                showToast('ì‹œë¦¬ì–¼ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            if (serial.length < 5) {
                showToast('ì‹œë¦¬ì–¼ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤');
                return;
            }

            if (scannedItems.some(function(i) { return i.serial === serial; })) {
                showToast('ì´ë¯¸ ì¶”ê°€ëœ ì‹œë¦¬ì–¼ì…ë‹ˆë‹¤');
                return;
            }

            // ì¡°íšŒ í›„ ì¸ì‹ ê²°ê³¼ì— í‘œì‹œ
            showRecognitionResult(serial);
            input.value = '';
        }

        // ===== Multi Serial =====
        function showMultiSerialModal(serials) {
            var modal = document.getElementById('multiSerialModal');
            var content = document.getElementById('multiSerialContent');

            var html = '<div class="modal-header">' +
                '<span class="modal-title">ì¸ì‹ëœ ì‹œë¦¬ì–¼ (' + serials.length + 'ê°œ)</span>' +
                '<button class="modal-close" onclick="closeMultiSerialModal()">Ã—</button></div>';

            html += '<div style="margin-bottom:12px;">';
            serials.forEach(function(sn, idx) {
                html += '<div style="padding:10px;background:var(--sju-gray-100);border-radius:6px;margin-bottom:8px;cursor:pointer;" ' +
                    'onclick="selectSingleSerial(\'' + sn + '\')">' +
                    '<div style="font-family:Consolas;font-weight:600;">' + sn + '</div>' +
                    '<div style="font-size:11px;color:var(--sju-gray-600);" id="multiStatus' + idx + '">ì¡°íšŒ ì¤‘...</div></div>';
            });
            html += '</div>';

            html += '<button class="case-btn secondary" onclick="closeMultiSerialModal()">ë‹«ê¸°</button>';

            content.innerHTML = html;
            modal.classList.add('active');

            // ìƒíƒœ ì¡°íšŒ
            serials.forEach(function(sn, idx) {
                lookupSerial(sn, currentDeptCode).then(function(result) {
                    var el = document.getElementById('multiStatus' + idx);
                    if (el) el.textContent = getStatusText(result.case, result.data);
                });
            });
        }

        function selectSingleSerial(serial) {
            closeMultiSerialModal();
            showRecognitionResult(serial);
        }

        function closeMultiSerialModal() {
            document.getElementById('multiSerialModal').classList.remove('active');
        }

        function getStatusText(caseType, data) {
            switch (caseType) {
                case 'A1-1': return 'ì •ìƒ (' + (data ? data.dept : '') + ')';
                case 'A1-2': return 'ìˆ˜ë¦¬ì¤‘';
                case 'A1-3': return 'íê¸°ë¨';
                case 'A1-4': return 'ë¶„ì‹¤';
                case 'A2-1': return 'ì´ë™ í•„ìš” (' + (data ? data.dept : '') + ')';
                case 'A2-2': return 'ì´ë™+ìˆ˜ë¦¬ì¤‘';
                case 'B1': return 'ë‚©í’ˆ ëŒ€ê¸°';
                case 'C1': return 'ë¯¸ë“±ë¡';
                default: return 'í™•ì¸ í•„ìš”';
            }
        }

        // ===== UI Update =====
        function updateUI() {
            var count = scannedItems.length;
            document.getElementById('headerCount').textContent = count + 'ê±´';
            document.getElementById('resultsCount').textContent = count + 'ê±´';

            var listEl = document.getElementById('resultsList');

            if (count === 0) {
                listEl.innerHTML = '<div class="empty-state">' +
                    '<div class="empty-icon">ğŸ“‹</div>' +
                    '<div class="empty-text">ìŠ¤ìº”ëœ ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤</div></div>';
                return;
            }

            listEl.innerHTML = scannedItems.map(function(item) {
                var icon = getStatusIcon(item.status);
                var badge = getBadge(item);
                var detail = getDetail(item);

                return '<div class="result-item" onclick="showItemDetail(\'' + item.serial + '\')">' +
                    '<div class="result-status ' + item.status + '">' + icon + '</div>' +
                    '<div class="result-info">' +
                        '<div class="result-serial">' + item.serial + '</div>' +
                        '<div class="result-detail">' + detail + '</div>' +
                    '</div>' +
                    '<span class="result-badge ' + badge.class + '">' + badge.text + '</span></div>';
            }).join('');
        }

        function getStatusIcon(status) {
            switch (status) {
                case 'ok': return 'âœ“';
                case 'move': return 'â†’';
                case 'warning': return '!';
                case 'new': return '+';
                default: return '?';
            }
        }

        function getBadge(item) {
            switch (item.action) {
                case 'checked': return { class: 'badge-ok', text: 'ì ê²€ì™„ë£Œ' };
                case 'repair-request': return { class: 'badge-repair', text: 'ìˆ˜ë¦¬ì ‘ìˆ˜' };
                case 'register': return { class: 'badge-registered', text: 'ì‹ ê·œë“±ë¡' };
                default: return { class: 'badge-unregistered', text: 'ë¯¸ì²˜ë¦¬' };
            }
        }

        function getDetail(item) {
            if (item.data) {
                return item.data.model + ' | ' + (item.data.dept || 'ë¯¸ì •');
            }
            return 'ë¯¸ë“±ë¡ ìì‚°';
        }

        function showItemDetail(serial) {
            var item = scannedItems.find(function(i) { return i.serial === serial; });
            if (!item) return;

            var modal = document.getElementById('caseModal');
            var content = document.getElementById('caseModalContent');

            var html = '<div class="modal-header">' +
                '<span class="modal-title">ìƒì„¸ ì •ë³´</span>' +
                '<button class="modal-close" onclick="closeCaseModal()">Ã—</button></div>';

            html += '<div class="case-info">' +
                '<div class="case-serial">' + item.serial + '</div>' +
                '<div class="case-detail">';
            if (item.data) {
                html += item.data.model + ' | ' + item.data.assetType + '<br>ë¶€ì„œ: ' + item.data.dept;
                if (item.data.user) html += ' | ' + item.data.user;
            } else {
                html += 'ë¯¸ë“±ë¡ ìì‚°';
            }
            html += '</div></div>';

            html += '<div class="case-actions">' +
                '<button class="case-btn success" onclick="changeItemAction(\'' + serial + '\', \'checked\')">ì ê²€ì™„ë£Œ</button>' +
                '<button class="case-btn warning" onclick="changeItemAction(\'' + serial + '\', \'repair-request\')">ìˆ˜ë¦¬ì ‘ìˆ˜</button>' +
                '<button class="case-btn accent" onclick="changeItemAction(\'' + serial + '\', \'register\')">ì‹ ê·œë“±ë¡</button>' +
                '<button class="case-btn secondary" onclick="removeItem(\'' + serial + '\')">ì‚­ì œ</button></div>';

            content.innerHTML = html;
            modal.classList.add('active');
        }

        function changeItemAction(serial, action) {
            var item = scannedItems.find(function(i) { return i.serial === serial; });
            if (!item) return;

            item.action = action;
            switch (action) {
                case 'checked': item.status = 'ok'; break;
                case 'repair-request': item.status = 'warning'; break;
                case 'register': item.status = 'new'; break;
            }

            closeCaseModal();
            updateUI();
            showToast('ë³€ê²½ë¨');
        }

        function removeItem(serial) {
            scannedItems = scannedItems.filter(function(i) { return i.serial !== serial; });
            closeCaseModal();
            updateUI();
            showToast('ì‚­ì œë¨');
        }

        function closeCaseModal() {
            document.getElementById('caseModal').classList.remove('active');
        }

        // ===== Complete Check =====
        function completeCheck() {
            if (scannedItems.length === 0) {
                showToast('ìŠ¤ìº”ëœ ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            var okCount = scannedItems.filter(function(i) { return i.status === 'ok'; }).length;
            var warnCount = scannedItems.filter(function(i) { return i.status === 'warning'; }).length;
            var newCount = scannedItems.filter(function(i) { return i.status === 'new'; }).length;

            var summary = 'ì ê²€ ì™„ë£Œ! ';
            summary += 'ì •ìƒ:' + okCount + ' ìˆ˜ë¦¬:' + warnCount + ' ë“±ë¡:' + newCount;

            showToast(summary);

            setTimeout(function() {
                scannedItems = [];
                tempRegistrations = {};
                clearRecognition();
                updateUI();
            }, 2500);
        }

        // ===== Utilities =====
        function showToast(msg) {
            var toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(function() { toast.classList.remove('show'); }, 2000);
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('active', show);
        }

        function resizeImage(file, maxWidth) {
            return new Promise(function(resolve) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var img = new Image();
                    img.onload = function() {
                        var canvas = document.createElement('canvas');
                        var w = img.width, h = img.height;
                        if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        var dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                        resolve({ dataUrl: dataUrl, base64: dataUrl.split(',')[1] });
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function callVisionAPI(base64, apiKey) {
            var resp = await fetch('https://vision.googleapis.com/v1/images:annotate?key=' + apiKey, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    requests: [{ image: { content: base64 }, features: [{ type: 'TEXT_DETECTION' }] }]
                })
            });
            var data = await resp.json();
            if (data.error) throw new Error(data.error.message);
            var ta = data.responses[0] && data.responses[0].textAnnotations;
            return ta && ta.length > 0 ? ta[0].description : null;
        }

        function extractSerials(text) {
            if (!text) return [];
            var exclude = /^(number|serial|model|part|product|type|version|no|sn|id|null|test)$/i;
            var candidates = [];
            var patterns = [
                /\b(\d{2,3}LG[A-Z]\d[A-Z][A-Z0-9]{10,})\b/gi,
                /\b(G[12]L\d{3}E\d{5}-\d{5})\b/gi,
                /\b(TAG-?N\d+[A-Z]+\d+-[A-Z]?\d+)\b/gi,
                /\b(CW[A-Z0-9]{2,4}H[0-9][A-Z]{2}[A-Z0-9]{6,})\b/gi,
                /\b(LED\d{10}[A-Z]\d)\b/gi,
                /\b([A-Z]{2,4}\d{2,4}[A-Z0-9]{6,})\b/gi,
                /\b(\d{3}[A-Z]{2,4}[A-Z0-9]{6,})\b/gi
            ];
            patterns.forEach(function(p) {
                var m = text.match(p);
                if (m) m.forEach(function(s) {
                    if (!exclude.test(s) && s.length >= 10) candidates.push(s);
                });
            });
            var unique = [], seen = {};
            candidates.forEach(function(c) { if (!seen[c]) { seen[c] = true; unique.push(c); } });
            return unique.slice(0, 5);
        }
    </script>
</body>
</html>
