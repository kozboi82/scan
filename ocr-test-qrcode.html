<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>S/N ìŠ¤ìºë„ˆ</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: sans-serif; padding: 10px; }
        #reader { width: 100%; max-width: 500px; }
        #result { margin-top: 20px; padding: 15px; background: #f0f0f0; }
        #manualCapture { display: none; margin-top: 10px; }
        .btn { padding: 10px 20px; font-size: 16px; margin: 5px; }
    </style>
</head>
<body>
    <h2>ğŸ“· S/N ìŠ¤ìºë„ˆ</h2>
    <p>QRì½”ë“œ, ë°”ì½”ë“œ, ë˜ëŠ” ë¼ë²¨ì„ ì¹´ë©”ë¼ì— ë¹„ì¶°ì£¼ì„¸ìš”</p>
    
    <!-- ì¹´ë©”ë¼ í™”ë©´ -->
    <div id="reader"></div>
    
    <!-- ì¸ì‹ ì•ˆ ë  ë•Œ ìˆ˜ë™ ì´¬ì˜ ë²„íŠ¼ -->
    <div id="manualCapture">
        <p>âš ï¸ ìë™ ì¸ì‹ì´ ì•ˆ ë˜ë‚˜ìš”?</p>
        <button class="btn" onclick="captureAndOCR()">
            ğŸ“¸ ì‚¬ì§„ ì°ì–´ì„œ OCR ì¸ì‹
        </button>
    </div>
    
    <!-- ê²°ê³¼ í‘œì‹œ -->
    <div id="result">
        <p>ëŒ€ê¸° ì¤‘...</p>
    </div>

    <script>
        let html5QrCode;
        let scanAttempts = 0;
        let manualCaptureTimer;
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìŠ¤ìºë„ˆ ì‹œì‘
        window.onload = function() {
            startScanner();
        };
        
        function startScanner() {
            html5QrCode = new Html5Qrcode("reader");
            
            html5QrCode.start(
                { facingMode: "environment" },  // í›„ë©´ ì¹´ë©”ë¼
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    // âœ… QR + ëª¨ë“  ì£¼ìš” ë°”ì½”ë“œ í¬ë§· ë™ì‹œ ì¸ì‹
                    formatsToSupport: [
                        Html5QrcodeSupportedFormats.QR_CODE,
                        Html5QrcodeSupportedFormats.CODE_128,
                        Html5QrcodeSupportedFormats.CODE_39,
                        Html5QrcodeSupportedFormats.EAN_13,
                        Html5QrcodeSupportedFormats.EAN_8,
                        Html5QrcodeSupportedFormats.UPC_A,
                        Html5QrcodeSupportedFormats.UPC_E,
                        Html5QrcodeSupportedFormats.ITF,
                        Html5QrcodeSupportedFormats.DATA_MATRIX,
                    ]
                },
                onScanSuccess,
                onScanFailure
            ).then(() => {
                // 5ì´ˆ í›„ì—ë„ ì¸ì‹ ì•ˆ ë˜ë©´ ìˆ˜ë™ ì´¬ì˜ ë²„íŠ¼ í‘œì‹œ
                manualCaptureTimer = setTimeout(() => {
                    document.getElementById('manualCapture').style.display = 'block';
                }, 5000);
            });
        }
        
        // âœ… QRì´ë“  ë°”ì½”ë“œë“  ì¸ì‹ ì„±ê³µ
        function onScanSuccess(decodedText, decodedResult) {
            // íƒ€ì´ë¨¸ ì·¨ì†Œ
            clearTimeout(manualCaptureTimer);
            
            // ì–´ë–¤ í˜•ì‹ìœ¼ë¡œ ì¸ì‹ëëŠ”ì§€ í™•ì¸
            const format = decodedResult.result.format.formatName;
            
            document.getElementById('result').innerHTML = `
                <p>âœ… <strong>${format}</strong>ìœ¼ë¡œ ì¸ì‹ë¨</p>
                <p>ğŸ“ ê°’: <strong>${decodedText}</strong></p>
                <p>ì„œë²„ ì¡°íšŒ ì¤‘...</p>
            `;
            
            // ì¹´ë©”ë¼ ì¤‘ì§€
            html5QrCode.stop();
            
            // ì„œë²„ë¡œ ì¡°íšŒ ìš”ì²­
            lookupSerialNumber(decodedText, format);
        }
        
        // ì¸ì‹ ì‹¤íŒ¨ (ê³„ì† ì‹œë„, ë¬´ì‹œí•´ë„ ë¨)
        function onScanFailure(errorMessage) {
            // ì¡°ìš©íˆ ë¬´ì‹œ (ê³„ì† ìŠ¤ìº” ì‹œë„í•¨)
        }
        
        // âœ… ìˆ˜ë™ ì´¬ì˜ â†’ OCR
        async function captureAndOCR() {
            try {
                // í˜„ì¬ í™”ë©´ ìº¡ì²˜
                const canvas = document.createElement('canvas');
                const video = document.querySelector('#reader video');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                // Base64ë¡œ ë³€í™˜
                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                
                document.getElementById('result').innerHTML = `
                    <p>ğŸ”„ OCR ì²˜ë¦¬ ì¤‘...</p>
                `;
                
                // ì¹´ë©”ë¼ ì¤‘ì§€
                html5QrCode.stop();
                
                // ì„œë²„ë¡œ OCR ìš”ì²­
                const response = await fetch('/api/ocr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData })
                });
                
                const result = await response.json();
                
                if (result.serialNumber) {
                    document.getElementById('result').innerHTML = `
                        <p>âœ… <strong>OCR</strong>ë¡œ ì¸ì‹ë¨</p>
                        <p>ğŸ“ ê°’: <strong>${result.serialNumber}</strong></p>
                    `;
                    lookupSerialNumber(result.serialNumber, 'OCR');
                } else {
                    document.getElementById('result').innerHTML = `
                        <p>âŒ ì¸ì‹ ì‹¤íŒ¨</p>
                        <button class="btn" onclick="location.reload()">ë‹¤ì‹œ ì‹œë„</button>
                    `;
                }
            } catch (error) {
                console.error('OCR ì˜¤ë¥˜:', error);
            }
        }
        
        // âœ… ì„œë²„ì—ì„œ S/N ì¡°íšŒ
        async function lookupSerialNumber(serialNumber, recognitionType) {
            try {
                const response = await fetch(`/api/asset/lookup?sn=${encodeURIComponent(serialNumber)}`);
                const asset = await response.json();
                
                if (asset.found) {
                    document.getElementById('result').innerHTML = `
                        <h3>âœ… ì¥ë¹„ ì •ë³´</h3>
                        <table>
                            <tr><td>ì¸ì‹ë°©ì‹</td><td>${recognitionType}</td></tr>
                            <tr><td>S/N</td><td>${serialNumber}</td></tr>
                            <tr><td>ëª¨ë¸</td><td>${asset.model}</td></tr>
                            <tr><td>ë¶€ì„œ</td><td>${asset.department}</td></tr>
                            <tr><td>ì‚¬ìš©ì</td><td>${asset.user}</td></tr>
                            <tr><td>ë“±ë¡ì¼</td><td>${asset.registeredDate}</td></tr>
                        </table>
                        <button class="btn" onclick="location.reload()">ë‹¤ë¥¸ ì¥ë¹„ ìŠ¤ìº”</button>
                    `;
                } else {
                    document.getElementById('result').innerHTML = `
                        <h3>âš ï¸ ë¯¸ë“±ë¡ ì¥ë¹„</h3>
                        <p>S/N: ${serialNumber}</p>
                        <button class="btn" onclick="registerNew('${serialNumber}')">ì‹ ê·œ ë“±ë¡</button>
                        <button class="btn" onclick="location.reload()">ë‹¤ì‹œ ìŠ¤ìº”</button>
                    `;
                }
            } catch (error) {
                console.error('ì¡°íšŒ ì˜¤ë¥˜:', error);
            }
        }
        
        function registerNew(serialNumber) {
            location.href = `/asset/register?sn=${encodeURIComponent(serialNumber)}`;
        }
    </script>
</body>
</html>