<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>QR/ë°”ì½”ë“œ ìŠ¤ìºë„ˆ (ê°œì„ íŒ)</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { 
            font-family: sans-serif; 
            padding: 10px; 
            background: #f0f0f0;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h2 { 
            color: #333; 
            text-align: center;
        }
        
        .scan-mode {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        
        .mode-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .mode-btn.active {
            background: #4ecca3;
            color: white;
            border-color: #4ecca3;
        }
        
        #reader { 
            width: 100%;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        
        .status.scanning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        #result { 
            margin-top: 20px; 
            padding: 20px; 
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }
        
        #result.show {
            display: block;
        }
        
        .result-header {
            font-size: 18px;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 10px;
        }
        
        .result-format {
            display: inline-block;
            padding: 4px 8px;
            background: #007bff;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        .result-value {
            font-family: 'Courier New', monospace;
            font-size: 16px;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            word-break: break-all;
        }
        
        .tips {
            margin-top: 20px;
            padding: 15px;
            background: #e8f4fd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .tips h3 {
            margin-top: 0;
            color: #0066cc;
        }
        
        .tips ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .btn {
            padding: 12px 24px;
            background: #4ecca3;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn:hover {
            background: #3db892;
        }
        
        .btn.secondary {
            background: #6c757d;
        }
        
        .btn.secondary:hover {
            background: #5a6268;
        }
        
        #manualCapture {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 8px;
            text-align: center;
        }
        
        .debug-info {
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ“· QR/ë°”ì½”ë“œ ìŠ¤ìºë„ˆ</h2>
        
        <!-- ìŠ¤ìº” ëª¨ë“œ ì„ íƒ -->
        <div class="scan-mode">
            <button class="mode-btn active" onclick="setScanMode('auto')">
                ğŸ”„ ìë™ ì¸ì‹<br>
                <small>QR + ë°”ì½”ë“œ</small>
            </button>
            <button class="mode-btn" onclick="setScanMode('qr')">
                â—» QR ì½”ë“œë§Œ<br>
                <small>ë¹ ë¥¸ ì¸ì‹</small>
            </button>
            <button class="mode-btn" onclick="setScanMode('barcode')">
                ||| ë°”ì½”ë“œë§Œ<br>
                <small>1ì°¨ì› ì½”ë“œ</small>
            </button>
        </div>
        
        <!-- ìƒíƒœ í‘œì‹œ -->
        <div id="status" class="status scanning">
            ğŸ” ì¹´ë©”ë¼ì— ì½”ë“œë¥¼ ë¹„ì¶°ì£¼ì„¸ìš”...
        </div>
        
        <!-- ì¹´ë©”ë¼ í™”ë©´ -->
        <div id="reader"></div>
        
        <!-- ìŠ¤ìº” íŒ -->
        <div class="tips">
            <h3>ğŸ’¡ ìŠ¤ìº” íŒ</h3>
            <div id="scan-tips">
                <strong>ìë™ ì¸ì‹ ëª¨ë“œ:</strong>
                <ul>
                    <li>QR ì½”ë“œ: 20-30cm ê±°ë¦¬</li>
                    <li>ë°”ì½”ë“œ: 10-15cm ê±°ë¦¬, ìˆ˜í‰ìœ¼ë¡œ</li>
                    <li>ë°ì€ ê³³ì—ì„œ ê·¸ë¦¼ì ì—†ì´</li>
                </ul>
            </div>
        </div>
        
        <!-- ìˆ˜ë™ ì´¬ì˜ ì˜µì…˜ -->
        <div id="manualCapture">
            <p>âš ï¸ ìë™ ì¸ì‹ì´ ì–´ë ¤ìš°ì‹ ê°€ìš”?</p>
            <button class="btn" onclick="captureAndOCR()">
                ğŸ“¸ ì‚¬ì§„ ì°ì–´ì„œ OCR ì¸ì‹
            </button>
        </div>
        
        <!-- ê²°ê³¼ í‘œì‹œ -->
        <div id="result">
            <div class="result-header">âœ… ì¸ì‹ ì„±ê³µ!</div>
            <div class="result-format" id="format-type">QR_CODE</div>
            <div class="result-value" id="result-value">-</div>
            <button class="btn" onclick="restartScanner()">ë‹¤ì‹œ ìŠ¤ìº”</button>
            <button class="btn secondary" onclick="lookupAsset()">ìì‚° ì¡°íšŒ</button>
        </div>
        
        <!-- ë””ë²„ê·¸ ì •ë³´ -->
        <div class="debug-info" style="display:none;" id="debug">
            <strong>Debug Info:</strong>
            <div id="debug-content"></div>
        </div>
    </div>

    <script>
        let html5QrCode;
        let currentMode = 'auto';
        let lastScannedValue = '';
        let scanAttempts = 0;
        let manualTimer;
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìŠ¤ìºë„ˆ ì‹œì‘
        window.onload = function() {
            startScanner();
        };
        
        // ìŠ¤ìº” ëª¨ë“œ ì„¤ì •
        function setScanMode(mode) {
            currentMode = mode;
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.mode-btn').classList.add('active');
            
            // íŒ ì—…ë°ì´íŠ¸
            updateTips(mode);
            
            // ìŠ¤ìºë„ˆ ì¬ì‹œì‘
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    startScanner();
                });
            }
        }
        
        // íŒ ì—…ë°ì´íŠ¸
        function updateTips(mode) {
            const tipsDiv = document.getElementById('scan-tips');
            
            if (mode === 'qr') {
                tipsDiv.innerHTML = `
                    <strong>QR ì½”ë“œ ì „ìš© ëª¨ë“œ:</strong>
                    <ul>
                        <li>ì •ì‚¬ê°í˜• QR ì½”ë“œì— ìµœì í™”</li>
                        <li>20-30cm ê±°ë¦¬ ê¶Œì¥</li>
                        <li>ë¹ ë¥¸ ì¸ì‹ ì†ë„</li>
                    </ul>
                `;
            } else if (mode === 'barcode') {
                tipsDiv.innerHTML = `
                    <strong>ë°”ì½”ë“œ ì „ìš© ëª¨ë“œ:</strong>
                    <ul>
                        <li>ğŸ“ 10-15cm ê°€ê¹Œì´</li>
                        <li>â¡ï¸ ìˆ˜í‰ìœ¼ë¡œ ì •ë ¬</li>
                        <li>ğŸ’¡ ë°ì€ ì¡°ëª… í•„ìˆ˜</li>
                        <li>ğŸ¯ ì¤‘ì•™ì— ì •í™•íˆ</li>
                    </ul>
                `;
            } else {
                tipsDiv.innerHTML = `
                    <strong>ìë™ ì¸ì‹ ëª¨ë“œ:</strong>
                    <ul>
                        <li>QR ì½”ë“œ: 20-30cm ê±°ë¦¬</li>
                        <li>ë°”ì½”ë“œ: 10-15cm ê±°ë¦¬, ìˆ˜í‰ìœ¼ë¡œ</li>
                        <li>ë°ì€ ê³³ì—ì„œ ê·¸ë¦¼ì ì—†ì´</li>
                    </ul>
                `;
            }
        }
        
        // ìŠ¤ìºë„ˆ ì‹œì‘
        function startScanner() {
            const statusDiv = document.getElementById('status');
            statusDiv.className = 'status scanning';
            statusDiv.innerHTML = 'ğŸ” ì¹´ë©”ë¼ì— ì½”ë“œë¥¼ ë¹„ì¶°ì£¼ì„¸ìš”...';
            
            html5QrCode = new Html5Qrcode("reader");
            
            // ëª¨ë“œë³„ ì„¤ì •
            let config = {
                fps: 10,
                qrbox: { width: 250, height: 250 }  // ê¸°ë³¸ê°’
            };
            
            let formats = [];
            
            if (currentMode === 'qr') {
                // QR ì½”ë“œë§Œ
                formats = [Html5QrcodeSupportedFormats.QR_CODE];
                config.qrbox = { width: 250, height: 250 };
            } else if (currentMode === 'barcode') {
                // ë°”ì½”ë“œë§Œ - ìŠ¤ìº” ë°•ìŠ¤ë¥¼ ê°€ë¡œë¡œ ê¸¸ê²Œ
                formats = [
                    Html5QrcodeSupportedFormats.CODE_128,
                    Html5QrcodeSupportedFormats.CODE_39,
                    Html5QrcodeSupportedFormats.EAN_13,
                    Html5QrcodeSupportedFormats.EAN_8,
                    Html5QrcodeSupportedFormats.UPC_A,
                    Html5QrcodeSupportedFormats.UPC_E,
                    Html5QrcodeSupportedFormats.ITF
                ];
                config.qrbox = { width: 350, height: 150 };  // ë°”ì½”ë“œìš© ê°€ë¡œ ë°•ìŠ¤
            } else {
                // ìë™ - ëª¨ë“  í¬ë§·
                formats = [
                    Html5QrcodeSupportedFormats.QR_CODE,
                    Html5QrcodeSupportedFormats.CODE_128,
                    Html5QrcodeSupportedFormats.CODE_39,
                    Html5QrcodeSupportedFormats.EAN_13,
                    Html5QrcodeSupportedFormats.EAN_8,
                    Html5QrcodeSupportedFormats.UPC_A,
                    Html5QrcodeSupportedFormats.UPC_E,
                    Html5QrcodeSupportedFormats.ITF,
                    Html5QrcodeSupportedFormats.DATA_MATRIX
                ];
                config.qrbox = { width: 280, height: 280 };  // ì¤‘ê°„ í¬ê¸°
            }
            
            config.formatsToSupport = formats;
            
            html5QrCode.start(
                { facingMode: "environment" },  // í›„ë©´ ì¹´ë©”ë¼
                config,
                onScanSuccess,
                onScanFailure
            ).then(() => {
                console.log('Scanner started in', currentMode, 'mode');
                
                // 10ì´ˆ í›„ ìˆ˜ë™ ì´¬ì˜ ì˜µì…˜ í‘œì‹œ
                clearTimeout(manualTimer);
                manualTimer = setTimeout(() => {
                    document.getElementById('manualCapture').style.display = 'block';
                }, 10000);
            }).catch(err => {
                console.error('Failed to start scanner:', err);
                statusDiv.className = 'status error';
                statusDiv.innerHTML = 'âŒ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: ' + err;
            });
        }
        
        // ìŠ¤ìº” ì„±ê³µ
        function onScanSuccess(decodedText, decodedResult) {
            clearTimeout(manualTimer);
            
            const format = decodedResult.result.format.formatName;
            lastScannedValue = decodedText;
            
            // ìƒíƒœ ì—…ë°ì´íŠ¸
            const statusDiv = document.getElementById('status');
            statusDiv.className = 'status success';
            statusDiv.innerHTML = 'âœ… ì¸ì‹ ì„±ê³µ!';
            
            // ê²°ê³¼ í‘œì‹œ
            document.getElementById('format-type').textContent = format;
            document.getElementById('result-value').textContent = decodedText;
            document.getElementById('result').classList.add('show');
            
            // ì§„ë™ í”¼ë“œë°± (ëª¨ë°”ì¼)
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }
            
            // ì¹´ë©”ë¼ ì¤‘ì§€
            html5QrCode.stop();
            
            // ë””ë²„ê·¸ ì •ë³´
            console.log('Scanned:', format, decodedText);
        }
        
        // ìŠ¤ìº” ì‹¤íŒ¨ (ê³„ì† ì‹œë„)
        function onScanFailure(errorMessage) {
            scanAttempts++;
            
            // 100ë²ˆ ì‹œë„ë§ˆë‹¤ ë””ë²„ê·¸ ë¡œê·¸
            if (scanAttempts % 100 === 0) {
                console.log('Scanning...', scanAttempts, 'attempts');
            }
        }
        
        // ìŠ¤ìºë„ˆ ì¬ì‹œì‘
        function restartScanner() {
            document.getElementById('result').classList.remove('show');
            document.getElementById('manualCapture').style.display = 'none';
            scanAttempts = 0;
            startScanner();
        }
        
        // ìì‚° ì¡°íšŒ
        function lookupAsset() {
            if (lastScannedValue) {
                // ì‹¤ì œë¡œëŠ” ì„œë²„ API í˜¸ì¶œ
                alert('ìì‚° ì¡°íšŒ: ' + lastScannedValue);
            }
        }
        
        // OCR ì´¬ì˜
        async function captureAndOCR() {
            try {
                const video = document.querySelector('#reader video');
                if (!video) {
                    alert('ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // ìº”ë²„ìŠ¤ì— í˜„ì¬ í™”ë©´ ìº¡ì²˜
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                // Base64ë¡œ ë³€í™˜
                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                
                // ì—¬ê¸°ì„œ OCR API í˜¸ì¶œ
                console.log('OCR image captured, size:', imageData.length);
                alert('OCR ê¸°ëŠ¥ì€ ì„œë²„ API ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                
            } catch (error) {
                console.error('OCR capture error:', error);
                alert('ìº¡ì²˜ ì‹¤íŒ¨: ' + error.message);
            }
        }
    </script>
</body>
</html>
