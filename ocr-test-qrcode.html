<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <title>QR/ë°”ì½”ë“œ ìŠ¤ìºë„ˆ</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 10px; 
            background: #f0f0f0;
            margin: 0;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h2 { 
            color: #333; 
            text-align: center;
            margin-bottom: 20px;
        }
        
        .scan-mode {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        
        .mode-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-align: center;
        }
        
        .mode-btn.active {
            background: #4ecca3;
            color: white;
            border-color: #4ecca3;
        }
        
        .mode-btn:hover {
            border-color: #4ecca3;
        }
        
        .mode-btn small {
            display: block;
            font-size: 11px;
            margin-top: 4px;
            opacity: 0.8;
        }
        
        #reader { 
            width: 100%;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            min-height: 300px;
            background: #000;
        }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
        }
        
        .status.scanning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        #result { 
            margin-top: 20px; 
            padding: 20px; 
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }
        
        #result.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-header {
            font-size: 18px;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 15px;
        }
        
        .result-info {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .result-format {
            display: inline-block;
            padding: 4px 8px;
            background: #007bff;
            color: white;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .result-length {
            display: inline-block;
            padding: 4px 8px;
            background: #6c757d;
            color: white;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .result-value {
            font-family: 'Courier New', monospace;
            font-size: 16px;
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            word-break: break-all;
            margin-bottom: 15px;
        }
        
        .tips {
            margin-top: 20px;
            padding: 15px;
            background: #e8f4fd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .tips h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #0066cc;
            font-size: 16px;
        }
        
        .tips ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .tips li {
            margin: 5px 0;
        }
        
        .btn {
            padding: 12px 24px;
            background: #4ecca3;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #3db892;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(78, 204, 163, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn.secondary {
            background: #6c757d;
        }
        
        .btn.secondary:hover {
            background: #5a6268;
        }
        
        #manualCapture {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 8px;
            text-align: center;
        }
        
        #manualCapture p {
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .scan-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 12px;
        }
        
        .scan-stat {
            text-align: center;
        }
        
        .scan-stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .scan-stat-label {
            color: #666;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ“· QR/ë°”ì½”ë“œ ìŠ¤ìºë„ˆ</h2>
        
        <!-- ìŠ¤ìº” ëª¨ë“œ ì„ íƒ -->
        <div class="scan-mode">
            <button class="mode-btn active" onclick="setScanMode('auto', this)">
                ğŸ”„ ìë™ ì¸ì‹
                <small>QR + ë°”ì½”ë“œ</small>
            </button>
            <button class="mode-btn" onclick="setScanMode('qr', this)">
                â—» QR ì½”ë“œë§Œ
                <small>ë¹ ë¥¸ ì¸ì‹</small>
            </button>
            <button class="mode-btn" onclick="setScanMode('barcode', this)">
                ||| ë°”ì½”ë“œë§Œ
                <small>1ì°¨ì› ì½”ë“œ</small>
            </button>
        </div>
        
        <!-- ìƒíƒœ í‘œì‹œ -->
        <div id="status" class="status scanning">
            ğŸ” ì¹´ë©”ë¼ì— ì½”ë“œë¥¼ ë¹„ì¶°ì£¼ì„¸ìš”...
        </div>
        
        <!-- ì¹´ë©”ë¼ í™”ë©´ -->
        <div id="reader"></div>
        
        <!-- ì‹¤ì‹œê°„ í†µê³„ -->
        <div class="scan-stats">
            <div class="scan-stat">
                <div class="scan-stat-value" id="scan-attempts">0</div>
                <div class="scan-stat-label">ìŠ¤ìº” ì‹œë„</div>
            </div>
            <div class="scan-stat">
                <div class="scan-stat-value" id="scan-time">0s</div>
                <div class="scan-stat-label">ê²½ê³¼ ì‹œê°„</div>
            </div>
            <div class="scan-stat">
                <div class="scan-stat-value" id="scan-mode">ìë™</div>
                <div class="scan-stat-label">í˜„ì¬ ëª¨ë“œ</div>
            </div>
        </div>
        
        <!-- ìŠ¤ìº” íŒ -->
        <div class="tips">
            <h3>ğŸ’¡ ìŠ¤ìº” íŒ</h3>
            <div id="scan-tips">
                <strong>ìë™ ì¸ì‹ ëª¨ë“œ:</strong>
                <ul>
                    <li>QR ì½”ë“œ: 20-30cm ê±°ë¦¬</li>
                    <li>ë°”ì½”ë“œ: 10-15cm ê±°ë¦¬, ìˆ˜í‰ìœ¼ë¡œ</li>
                    <li>ë°ì€ ê³³ì—ì„œ ê·¸ë¦¼ì ì—†ì´</li>
                </ul>
            </div>
        </div>
        
        <!-- ìˆ˜ë™ ì´¬ì˜ ì˜µì…˜ -->
        <div id="manualCapture">
            <p>âš ï¸ ìë™ ì¸ì‹ì´ ì–´ë ¤ìš°ì‹ ê°€ìš”?</p>
            <button class="btn" onclick="captureAndOCR()">
                ğŸ“¸ ì‚¬ì§„ ì°ì–´ì„œ OCR ì¸ì‹
            </button>
        </div>
        
        <!-- ê²°ê³¼ í‘œì‹œ -->
        <div id="result">
            <div class="result-header">âœ… ì¸ì‹ ì„±ê³µ!</div>
            <div class="result-info">
                <span class="result-format" id="format-type">QR_CODE</span>
                <span class="result-length" id="result-length">0ì</span>
            </div>
            <div class="result-value" id="result-value">-</div>
            <button class="btn" onclick="restartScanner()">ë‹¤ì‹œ ìŠ¤ìº”</button>
            <button class="btn secondary" onclick="copyResult()">ê²°ê³¼ ë³µì‚¬</button>
        </div>
    </div>

    <script>
        let html5QrCode;
        let currentMode = 'auto';
        let lastScannedValue = '';
        let scanAttempts = 0;
        let manualTimer;
        let startTime;
        let statsInterval;
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìŠ¤ìºë„ˆ ì‹œì‘
        window.onload = function() {
            startScanner();
        };
        
        // ìŠ¤ìº” ëª¨ë“œ ì„¤ì •
        function setScanMode(mode, btn) {
            currentMode = mode;
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.mode-btn').forEach(b => {
                b.classList.remove('active');
            });
            btn.classList.add('active');
            
            // ëª¨ë“œ í‘œì‹œ ì—…ë°ì´íŠ¸
            const modeText = {
                'auto': 'ìë™',
                'qr': 'QR',
                'barcode': 'ë°”ì½”ë“œ'
            };
            document.getElementById('scan-mode').textContent = modeText[mode];
            
            // íŒ ì—…ë°ì´íŠ¸
            updateTips(mode);
            
            // ìŠ¤ìºë„ˆ ì¬ì‹œì‘
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    startScanner();
                }).catch(err => {
                    console.error('Failed to stop scanner:', err);
                    startScanner();
                });
            }
        }
        
        // íŒ ì—…ë°ì´íŠ¸
        function updateTips(mode) {
            const tipsDiv = document.getElementById('scan-tips');
            
            if (mode === 'qr') {
                tipsDiv.innerHTML = `
                    <strong>QR ì½”ë“œ ì „ìš© ëª¨ë“œ:</strong>
                    <ul>
                        <li>ì •ì‚¬ê°í˜• QR ì½”ë“œì— ìµœì í™”</li>
                        <li>20-30cm ê±°ë¦¬ ê¶Œì¥</li>
                        <li>ë¹ ë¥¸ ì¸ì‹ ì†ë„</li>
                    </ul>
                `;
            } else if (mode === 'barcode') {
                tipsDiv.innerHTML = `
                    <strong>ë°”ì½”ë“œ ì „ìš© ëª¨ë“œ:</strong>
                    <ul>
                        <li>ğŸ“ 10-15cm ê°€ê¹Œì´</li>
                        <li>â¡ï¸ ìˆ˜í‰ìœ¼ë¡œ ì •ë ¬</li>
                        <li>ğŸ’¡ ë°ì€ ì¡°ëª… í•„ìˆ˜</li>
                        <li>ğŸ¯ ì¤‘ì•™ì— ì •í™•íˆ</li>
                    </ul>
                `;
            } else {
                tipsDiv.innerHTML = `
                    <strong>ìë™ ì¸ì‹ ëª¨ë“œ:</strong>
                    <ul>
                        <li>QR ì½”ë“œ: 20-30cm ê±°ë¦¬</li>
                        <li>ë°”ì½”ë“œ: 10-15cm ê±°ë¦¬, ìˆ˜í‰ìœ¼ë¡œ</li>
                        <li>ë°ì€ ê³³ì—ì„œ ê·¸ë¦¼ì ì—†ì´</li>
                    </ul>
                `;
            }
        }
        
        // ìŠ¤ìºë„ˆ ì‹œì‘
        function startScanner() {
            const statusDiv = document.getElementById('status');
            statusDiv.className = 'status scanning';
            statusDiv.innerHTML = 'ğŸ” ì¹´ë©”ë¼ì— ì½”ë“œë¥¼ ë¹„ì¶°ì£¼ì„¸ìš”...';
            
            // ì´ˆê¸°í™”
            scanAttempts = 0;
            startTime = Date.now();
            document.getElementById('result').classList.remove('show');
            document.getElementById('manualCapture').style.display = 'none';
            
            // í†µê³„ ì—…ë°ì´íŠ¸ ì‹œì‘
            if (statsInterval) clearInterval(statsInterval);
            statsInterval = setInterval(updateStats, 1000);
            
            html5QrCode = new Html5Qrcode("reader");
            
            // ëª¨ë“œë³„ ì„¤ì •
            let config = {
                fps: 10,
                qrbox: { width: 250, height: 250 }
            };
            
            let formats = [];
            
            if (currentMode === 'qr') {
                formats = [Html5QrcodeSupportedFormats.QR_CODE];
                config.qrbox = { width: 250, height: 250 };
            } else if (currentMode === 'barcode') {
                formats = [
                    Html5QrcodeSupportedFormats.CODE_128,
                    Html5QrcodeSupportedFormats.CODE_39,
                    Html5QrcodeSupportedFormats.EAN_13,
                    Html5QrcodeSupportedFormats.EAN_8,
                    Html5QrcodeSupportedFormats.UPC_A,
                    Html5QrcodeSupportedFormats.UPC_E,
                    Html5QrcodeSupportedFormats.ITF
                ];
                config.qrbox = { width: 350, height: 150 };
            } else {
                formats = [
                    Html5QrcodeSupportedFormats.QR_CODE,
                    Html5QrcodeSupportedFormats.CODE_128,
                    Html5QrcodeSupportedFormats.CODE_39,
                    Html5QrcodeSupportedFormats.EAN_13,
                    Html5QrcodeSupportedFormats.EAN_8,
                    Html5QrcodeSupportedFormats.UPC_A,
                    Html5QrcodeSupportedFormats.UPC_E,
                    Html5QrcodeSupportedFormats.ITF,
                    Html5QrcodeSupportedFormats.DATA_MATRIX
                ];
                config.qrbox = { width: 280, height: 280 };
            }
            
            config.formatsToSupport = formats;
            
            html5QrCode.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanFailure
            ).then(() => {
                console.log('Scanner started in', currentMode, 'mode');
                
                clearTimeout(manualTimer);
                manualTimer = setTimeout(() => {
                    document.getElementById('manualCapture').style.display = 'block';
                }, 10000);
            }).catch(err => {
                console.error('Failed to start scanner:', err);
                statusDiv.className = 'status error';
                statusDiv.innerHTML = 'âŒ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: ' + err.message;
                clearInterval(statsInterval);
            });
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('scan-time').textContent = elapsed + 's';
            document.getElementById('scan-attempts').textContent = scanAttempts;
        }
        
        // ìŠ¤ìº” ì„±ê³µ
        function onScanSuccess(decodedText, decodedResult) {
            clearTimeout(manualTimer);
            clearInterval(statsInterval);
            
            const format = decodedResult.result.format.formatName;
            lastScannedValue = decodedText;
            
            const statusDiv = document.getElementById('status');
            statusDiv.className = 'status success';
            statusDiv.innerHTML = 'âœ… ì¸ì‹ ì„±ê³µ!';
            
            document.getElementById('format-type').textContent = format;
            document.getElementById('result-value').textContent = decodedText;
            document.getElementById('result-length').textContent = decodedText.length + 'ì';
            document.getElementById('result').classList.add('show');
            
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }
            
            html5QrCode.stop().catch(err => {
                console.error('Failed to stop:', err);
            });
            
            console.log('Scanned:', format, decodedText);
        }
        
        // ìŠ¤ìº” ì‹¤íŒ¨ (ê³„ì† ì‹œë„)
        function onScanFailure(errorMessage) {
            scanAttempts++;
        }
        
        // ìŠ¤ìºë„ˆ ì¬ì‹œì‘
        function restartScanner() {
            document.getElementById('result').classList.remove('show');
            document.getElementById('manualCapture').style.display = 'none';
            scanAttempts = 0;
            startScanner();
        }
        
        // ê²°ê³¼ ë³µì‚¬
        function copyResult() {
            if (lastScannedValue) {
                navigator.clipboard.writeText(lastScannedValue).then(() => {
                    alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: ' + lastScannedValue);
                }).catch(err => {
                    alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err);
                });
            }
        }
        
        // OCR ì´¬ì˜
        async function captureAndOCR() {
            try {
                const video = document.querySelector('#reader video');
                if (!video) {
                    alert('ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                
                console.log('OCR image captured, size:', imageData.length);
                alert('OCR ê¸°ëŠ¥ì€ ì„œë²„ API ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                
            } catch (error) {
                console.error('OCR capture error:', error);
                alert('ìº¡ì²˜ ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            if (html5QrCode) {
                html5QrCode.stop().catch(() => {});
            }
            if (statsInterval) {
                clearInterval(statsInterval);
            }
        });
    </script>
</body>
</html>
